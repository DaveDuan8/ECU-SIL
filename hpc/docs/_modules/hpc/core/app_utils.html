
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=cp1252" />
    <title>hpc.core.app_utils</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="index" title="Index" href="../../../genindex.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HPC 2.12.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for hpc.core.app_utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">app_utils.py</span>
<span class="sd">------------</span>

<span class="sd">Utilities needed by the starter and maybe also by others</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=E0611,C0413,C0412</span>
<span class="c1"># - import Python modules ----------------------------------------------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">linesep</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">splitext</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">expandvars</span><span class="p">,</span> <span class="n">sep</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span><span class="p">,</span> <span class="n">STDOUT</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">packaging.version</span> <span class="kn">import</span> <span class="n">Version</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">distutils.version</span> <span class="kn">import</span> <span class="n">LooseVersion</span> <span class="k">as</span> <span class="n">Version</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">split</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="nb">compile</span> <span class="k">as</span> <span class="n">recomp</span><span class="p">,</span> <span class="n">escape</span><span class="p">,</span> <span class="n">IGNORECASE</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># deprecated on Python 3.10</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">inf</span>
<span class="kn">from</span> <span class="nn">psutil</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">NoSuchProcess</span><span class="p">,</span> <span class="n">cpu_times</span><span class="p">,</span> <span class="n">virtual_memory</span><span class="p">,</span> <span class="n">net_io_counters</span><span class="p">,</span> <span class="n">disk_io_counters</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">PY3</span><span class="p">,</span> <span class="n">iteritems</span>

<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Timer</span>
    <span class="n">StringTypes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">,)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">azure.storage.blob</span> <span class="kn">import</span> <span class="n">BlobClient</span>
        <span class="c1"># from azure.storage.blob.blockblobservice import BlockBlobService as BlobClient</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">BlobClient</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">_Timer</span> <span class="k">as</span> <span class="n">Timer</span>
    <span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">StringTypes</span>
    <span class="n">BlobClient</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">docker</span> <span class="kn">import</span> <span class="n">from_env</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">from_env</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">MSWIN</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span>
<span class="k">if</span> <span class="n">MSWIN</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">win32con</span> <span class="kn">import</span> <span class="n">WM_CLOSE</span>
    <span class="kn">from</span> <span class="nn">win32gui</span> <span class="kn">import</span> <span class="n">EnumWindows</span><span class="p">,</span> <span class="n">PostMessage</span><span class="p">,</span> <span class="n">IsWindowEnabled</span>  <span class="c1"># ,GetWindowText</span>
    <span class="kn">from</span> <span class="nn">win32process</span> <span class="kn">import</span> <span class="n">GetWindowThreadProcessId</span>
    <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">CREATE_NEW_PROCESS_GROUP</span>
    <span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">CTRL_BREAK_EVENT</span>
    <span class="kn">from</span> <span class="nn">win32api</span> <span class="kn">import</span> <span class="n">GetFileVersionInfo</span><span class="p">,</span> <span class="n">LOWORD</span><span class="p">,</span> <span class="n">HIWORD</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">SIGINT</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">psutil</span> <span class="kn">import</span> <span class="n">NUM_CPUS</span> <span class="k">as</span> <span class="n">CPU_CNT</span><span class="p">,</span> <span class="n">AccessDenied</span>  <span class="c1"># pylint: disable=C0412</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">psutil</span> <span class="kn">import</span> <span class="n">cpu_count</span><span class="p">,</span> <span class="n">AccessDenied</span>  <span class="c1"># pylint: disable=C0412</span>
    <span class="n">CPU_CNT</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span>

<span class="c1"># - HPC imports --------------------------------------------------------------------------------------------------------</span>
<span class="kn">from</span> <span class="nn">..core.error</span> <span class="kn">import</span> <span class="n">ERR_OK</span><span class="p">,</span> <span class="n">ERR_HPC_APPLICATION_NOT_LOCAL</span><span class="p">,</span> <span class="n">ERR_APPLICATION_WRAPPER</span><span class="p">,</span> <span class="n">HpcError</span>
<span class="kn">from</span> <span class="nn">..core.logger</span> <span class="kn">import</span> <span class="n">get_logger</span>

<span class="c1"># - defines ------------------------------------------------------------------------------------------------------------</span>
<span class="n">REPORT_WAIT_TIME_INITIAL</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">240</span><span class="p">]</span>  <span class="c1"># Initial Wait Time for 1. Report in [s] for regular / mts apps</span>
<span class="n">REPORT_WAIT_TIME_CYCLE</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># time to wait between to requests in [s]</span>
<span class="n">MAX_TIME_WATCH</span> <span class="o">=</span> <span class="mf">120.</span>  <span class="c1"># [h] of a task to run</span>
<span class="n">EXIT_GRACE_TIME</span> <span class="o">=</span> <span class="mf">120.</span>  <span class="c1"># [s] of a task to finish up after CTRL+break / WM_CLOSE</span>

<span class="n">TIME</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>
<span class="n">PROC_TIME</span> <span class="o">=</span> <span class="s1">&#39;ProcTime&#39;</span>
<span class="n">MEM_BYTES</span> <span class="o">=</span> <span class="s1">&#39;Membytes&#39;</span>
<span class="n">COM_BYTES</span> <span class="o">=</span> <span class="s1">&#39;CommittedSize&#39;</span>
<span class="n">IO_CNT</span> <span class="o">=</span> <span class="s1">&#39;IoCount&#39;</span>

<span class="n">FATALS</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;WindowsError: \[Error 1455\] The paging file is too small for this operation to complete&quot;</span>


<span class="c1"># - classes and functions ----------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="MonDataCollector"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.MonDataCollector">[docs]</a><span class="k">class</span> <span class="nc">MonDataCollector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0902</span>
    <span class="sd">&quot;&quot;&quot;class which provides all needed monitor values from a process.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MonDataCollector.__init__"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.MonDataCollector.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">taskfolder</span><span class="p">,</span> <span class="n">docker</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        init monitor data collector</span>

<span class="sd">        :param Process proc: running process</span>
<span class="sd">        :param logging.Logger logger: logger instance to use</span>
<span class="sd">        :param str taskfolder: task folder</span>
<span class="sd">        :param str docker: name of docker to take CPU, MEM and I/O from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="n">proc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accdenied</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ctm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">create_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">ctm</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctm</span><span class="p">,</span> <span class="n">Callable</span><span class="p">)</span> <span class="k">else</span> <span class="n">ctm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">from_env</span> <span class="ow">and</span> <span class="n">docker</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cli</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span> <span class="o">=</span> <span class="n">from_env</span><span class="p">(),</span> <span class="n">docker</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_stats</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_first_tm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_tm</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_io</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_io</span> <span class="o">=</span> <span class="n">net_io_counters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_offs_cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_cpu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cpu</span> <span class="o">=</span> <span class="n">cpu_times</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_disk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_disk</span> <span class="o">=</span> <span class="n">disk_io_counters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">io_tm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_load</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virt_load</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Callable</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">name</span>

        <span class="n">mem_fn</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;mem_dump_%Y.%m.</span><span class="si">%d</span><span class="s2">_%H.%M.%S.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mem_file</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">taskfolder</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">mem_fn</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mem_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv</span><span class="p">:</span>
                <span class="n">csv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;time;CPU load [%];total CPU load [%];disk I/O traffic [B/s];total net I/O traffic [B/s];&quot;</span>
                          <span class="s2">&quot;Mem load [B];total Mem load[B]&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;mem dump file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mem_fn</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;writing log: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">net_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: network io until now</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_tm</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_tm</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_io</span><span class="o">.</span><span class="n">bytes_sent</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_io</span><span class="o">.</span><span class="n">bytes_recv</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_io</span><span class="o">.</span><span class="n">bytes_sent</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_io</span><span class="o">.</span><span class="n">bytes_recv</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_tm</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_tm</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tot_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: CPU utilization until now</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_tm</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_tm</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_cpu</span><span class="o">.</span><span class="n">user</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cpu</span><span class="o">.</span><span class="n">system</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_cpu</span><span class="o">.</span><span class="n">user</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_cpu</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_tm</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_tm</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">/</span> <span class="n">CPU_CNT</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tot_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: total disk I/O until now</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_disk</span><span class="o">.</span><span class="n">read_bytes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_disk</span><span class="o">.</span><span class="n">write_bytes</span>
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_disk</span><span class="o">.</span><span class="n">read_bytes</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_disk</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get io and cpu values&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_stats</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">RuntimeWarning</span><span class="p">(</span><span class="s1">&#39;process is not available&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">io_load</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">IO_CNT</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_tm</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">TIME</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_load</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">virt_load</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">MEM_BYTES</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="n">COM_BYTES</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_time</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">PROC_TIME</span><span class="p">]</span>

        <span class="n">delta_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">TIME</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">[</span><span class="n">TIME</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="c1"># load times are in 100ns ticks -&gt; conversion to seconds -&gt; to percentage from 1s</span>
        <span class="c1"># CPU load can be greater then 100% due to multi core usage but this is not of interest to us</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span><span class="p">:</span>
            <span class="n">cpu_load</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cpu_load</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">PROC_TIME</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">[</span><span class="n">PROC_TIME</span><span class="p">]))</span> <span class="o">/</span> <span class="n">delta_time</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">/</span> <span class="n">CPU_CNT</span>

        <span class="c1"># i/o traffic in [kB/s]</span>
        <span class="n">io_load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">IO_CNT</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">[</span><span class="n">IO_CNT</span><span class="p">])</span> <span class="o">/</span> <span class="n">delta_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span> <span class="o">=</span> <span class="n">vals</span>

        <span class="c1"># same goes for global:</span>
        <span class="n">tm_now</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

        <span class="n">cpu_now</span> <span class="o">=</span> <span class="n">cpu_times</span><span class="p">()</span>
        <span class="n">glob_cpu</span> <span class="o">=</span> <span class="p">((</span><span class="n">cpu_now</span><span class="o">.</span><span class="n">user</span> <span class="o">+</span> <span class="n">cpu_now</span><span class="o">.</span><span class="n">system</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cpu</span><span class="o">.</span><span class="n">user</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_cpu</span><span class="o">.</span><span class="n">system</span><span class="p">)</span> <span class="o">/</span>
                    <span class="p">(</span><span class="n">tm_now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_tm</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">/</span> <span class="n">CPU_CNT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_cpu</span> <span class="o">=</span> <span class="n">cpu_now</span>

        <span class="n">io_now</span> <span class="o">=</span> <span class="n">net_io_counters</span><span class="p">()</span>
        <span class="n">net_io</span> <span class="o">=</span> <span class="p">((</span><span class="n">io_now</span><span class="o">.</span><span class="n">bytes_sent</span> <span class="o">+</span> <span class="n">io_now</span><span class="o">.</span><span class="n">bytes_recv</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_offs_cnt</span>
                   <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_io</span><span class="o">.</span><span class="n">bytes_sent</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_io</span><span class="o">.</span><span class="n">bytes_recv</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tm_now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_tm</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_io</span> <span class="o">=</span> <span class="n">io_now</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_last_disk</span> <span class="o">=</span> <span class="n">disk_io_counters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_tm</span> <span class="o">=</span> <span class="n">tm_now</span>

        <span class="c1"># dump memory log to file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mem_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv</span><span class="p">:</span>
                <span class="n">csv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">;</span><span class="si">%.1f</span><span class="s2">;</span><span class="si">%.1f</span><span class="s2">;</span><span class="si">%d</span><span class="s2">;</span><span class="si">%d</span><span class="s2">;</span><span class="si">%d</span><span class="s2">;</span><span class="si">%d</span><span class="s2">&quot;</span>
                          <span class="o">%</span> <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">TIME</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span> <span class="n">cpu_load</span><span class="p">,</span> <span class="n">glob_cpu</span><span class="p">,</span> <span class="n">io_load</span><span class="p">,</span> <span class="n">net_io</span><span class="p">,</span>
                             <span class="n">vals</span><span class="p">[</span><span class="n">MEM_BYTES</span><span class="p">],</span> <span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">used</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;appending log: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">io_load</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">,</span> <span class="n">cpu_load</span>

<div class="viewcode-block" id="MonDataCollector.process_stats"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.MonDataCollector.process_stats">[docs]</a>    <span class="k">def</span> <span class="nf">process_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0915,R1260</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get current process states.</span>

<span class="sd">        :return:    process states</span>
<span class="sd">        :rtype:     dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">TIME</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span> <span class="n">PROC_TIME</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IO_CNT</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MEM_BYTES</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">COM_BYTES</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="k">def</span> <span class="nf">_childs</span><span class="p">(</span><span class="n">pids</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0912</span>
            <span class="sd">&quot;&quot;&quot;iterate through childs&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">except</span> <span class="n">NoSuchProcess</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ctm</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">cpu_times</span><span class="p">()</span>
                    <span class="n">vals</span><span class="p">[</span><span class="n">PROC_TIME</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ctm</span><span class="o">.</span><span class="n">user</span> <span class="o">+</span> <span class="n">ctm</span><span class="o">.</span><span class="n">system</span>

                    <span class="k">if</span> <span class="n">MSWIN</span><span class="p">:</span>
                        <span class="n">ioc</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">io_counters</span><span class="p">()</span>
                        <span class="n">vals</span><span class="p">[</span><span class="n">IO_CNT</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">.</span><span class="n">read_bytes</span> <span class="o">+</span> <span class="n">ioc</span><span class="o">.</span><span class="n">write_bytes</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">MSWIN</span><span class="p">:</span>
                            <span class="n">mem</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">memory_full_info</span><span class="p">()</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">MEM_BYTES</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mem</span><span class="o">.</span><span class="n">uss</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">COM_BYTES</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mem</span><span class="o">.</span><span class="n">vms</span> <span class="o">+</span> <span class="n">mem</span><span class="o">.</span><span class="n">rss</span> <span class="o">+</span> <span class="n">mem</span><span class="o">.</span><span class="n">pagefile</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                            <span class="n">mem</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">MEM_BYTES</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mem</span><span class="o">.</span><span class="n">rss</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">COM_BYTES</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mem</span><span class="o">.</span><span class="n">vms</span> <span class="o">+</span> <span class="n">mem</span><span class="o">.</span><span class="n">rss</span> <span class="o">+</span> <span class="n">mem</span><span class="o">.</span><span class="n">shared</span>
                    <span class="k">except</span> <span class="n">AccessDenied</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accdenied</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_accdenied</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no access to mem info for PID </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

                    <span class="n">_childs</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">children</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_docker</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cli</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;docker running: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span><span class="o">.</span><span class="n">short_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_docker</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
                    <span class="n">_childs</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span><span class="o">.</span><span class="n">top</span><span class="p">(</span><span class="n">ps_args</span><span class="o">=</span><span class="s2">&quot;o pid&quot;</span><span class="p">)[</span><span class="s2">&quot;Processes&quot;</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;docker not running: state=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PID retrieval failed: state=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_childs</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">vals</span></div></div>


<div class="viewcode-block" id="replace_env_vars"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.replace_env_vars">[docs]</a><span class="k">def</span> <span class="nf">replace_env_vars</span><span class="p">(</span><span class="n">hpc</span><span class="p">,</span> <span class="n">lot</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    replace a list of things by environmental variables</span>

<span class="sd">    :param Starter hpc: the app starter</span>
<span class="sd">    :param list lot: list of things</span>
<span class="sd">    :return: replaced list</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">lot</span><span class="p">:</span>
        <span class="n">old</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lot</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lot</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                    <span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_expandvars</span><span class="p">(</span><span class="n">hpc</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lot</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">_expandvars</span><span class="p">(</span><span class="n">hpc</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lot</span></div>


<span class="k">def</span> <span class="nf">_expandvars</span><span class="p">(</span><span class="n">hpc</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;expand environment variables&quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">expandvars</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;JobID&quot;</span><span class="p">,</span> <span class="n">hpc</span><span class="o">.</span><span class="n">jobid</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;JobName&quot;</span><span class="p">,</span> <span class="n">hpc</span><span class="o">.</span><span class="n">jobname</span><span class="p">,),</span>
                 <span class="p">(</span><span class="s2">&quot;TaskID&quot;</span><span class="p">,</span> <span class="n">hpc</span><span class="o">.</span><span class="n">task_id</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;TaskName&quot;</span><span class="p">,</span> <span class="n">hpc</span><span class="o">.</span><span class="n">taskname</span><span class="p">,),</span>
                 <span class="p">(</span><span class="s2">&quot;HPCTaskDataFolder&quot;</span><span class="p">,</span> <span class="n">hpc</span><span class="o">.</span><span class="n">datafolder</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;HPCTaskTmpFolder&quot;</span><span class="p">,</span> <span class="n">hpc</span><span class="o">.</span><span class="n">tempfolder</span><span class="p">,),):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="s1">&#39;%</span><span class="si">{}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">escape</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">var</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">IGNORECASE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">var</span>


<div class="viewcode-block" id="try_sleep"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.try_sleep">[docs]</a><span class="k">def</span> <span class="nf">try_sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;catch IOError and forget about it (https://mail.python.org/pipermail/python-list/2008-August/485397.html)&quot;&quot;&quot;</span>
    <span class="n">until</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">seconds</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">seconds</span> <span class="o">/</span> <span class="mf">13.</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">),</span> <span class="mf">1.65</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">until</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="perr"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.perr">[docs]</a><span class="k">def</span> <span class="nf">perr</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    print to stderr</span>

<span class="sd">    :param str text: text to print</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span> <span class="o">+</span> <span class="n">linesep</span><span class="p">)</span></div>


<div class="viewcode-block" id="file_version"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.file_version">[docs]</a><span class="k">def</span> <span class="nf">file_version</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extract file version&quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">GetFileVersionInfo</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>
    <span class="n">fms</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;FileVersionMS&#39;</span><span class="p">]</span>
    <span class="n">fls</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;FileVersionLS&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HIWORD</span><span class="p">(</span><span class="n">fms</span><span class="p">),</span> <span class="n">LOWORD</span><span class="p">(</span><span class="n">fms</span><span class="p">),</span> <span class="n">HIWORD</span><span class="p">(</span><span class="n">fls</span><span class="p">),</span> <span class="n">LOWORD</span><span class="p">(</span><span class="n">fls</span><span class="p">)))</span></div>


<div class="viewcode-block" id="webscape"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.webscape">[docs]</a><span class="k">def</span> <span class="nf">webscape</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    took it from html package,</span>
<span class="sd">    there might me more to convert, see e.g. here: https://devpractical.com/display-html-tags-as-plain-text/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ori</span> <span class="o">=</span> <span class="n">txt</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;amp;&quot;</span><span class="p">)</span>  <span class="c1"># Must be done first!</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;lt;&quot;</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;gt;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ori</span> <span class="o">!=</span> <span class="n">txt</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&amp;quot;&quot;</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;&amp;#x27;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">txt</span><span class="p">,</span> <span class="n">ori</span> <span class="o">==</span> <span class="n">txt</span></div>


<div class="viewcode-block" id="ArgumentParserError"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.ArgumentParserError">[docs]</a><span class="k">class</span> <span class="nc">ArgumentParserError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;placeholder for parser exceptions&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="HpcArgumentParser"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.HpcArgumentParser">[docs]</a><span class="k">class</span> <span class="nc">HpcArgumentParser</span><span class="p">(</span><span class="n">ArgumentParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;HPC argument parser wrapper exception&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HpcArgumentParser.__init__"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.HpcArgumentParser.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;overload&quot;&quot;&quot;</span>
        <span class="n">ArgumentParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="HpcArgumentParser.error"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.HpcArgumentParser.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        print a usage message incorporating the message to stderr and exits.</span>

<span class="sd">        If you override this in a subclass, it should not return -- it</span>
<span class="sd">        should either exit or raise an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">ArgumentParserError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NonBlockingStreamReader"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.NonBlockingStreamReader">[docs]</a><span class="k">class</span> <span class="nc">NonBlockingStreamReader</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0903,R0902</span>
    <span class="sd">&quot;&quot;&quot;the non-blocking stream reader (intended for stdout and stderr)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NonBlockingStreamReader.__init__"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.NonBlockingStreamReader.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        stream: the stream to read from.</span>
<span class="sd">                Usually a process&#39; stdout or stderr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strm</span> <span class="o">=</span> <span class="n">stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span> <span class="o">=</span> <span class="n">writer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inverse</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inverse&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fatals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fatcnt</span> <span class="o">=</span> <span class="n">recomp</span><span class="p">(</span><span class="n">FATALS</span><span class="p">),</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prnlines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stoptm</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="NonBlockingStreamReader.run"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.NonBlockingStreamReader.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0912,R1260</span>
        <span class="sd">&quot;&quot;&quot;Collect lines from &#39;stream&#39; and put them in &#39;quque&#39;.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>  <span class="c1"># pylint: disable=R1702</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strm</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)):</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">l</span><span class="p">:</span>
                        <span class="n">mtc</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">:</span>
                            <span class="n">mtc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse</span><span class="p">:</span>
                                <span class="n">mtc</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">mtc</span>
                        <span class="k">if</span> <span class="n">mtc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">PY3</span><span class="p">:</span>
                                <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">l</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="n">webscape</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span><span class="p">(</span><span class="n">l</span> <span class="k">if</span> <span class="n">o</span> <span class="k">else</span> <span class="s2">&quot;&lt;tt&gt;</span><span class="si">{}</span><span class="s2">&lt;/tt&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;logging error &#39;</span><span class="si">{!s}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fatals</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_fatcnt</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="c1"># call back function on certain messages</span>
                        <span class="k">for</span> <span class="nb">cmp</span><span class="p">,</span> <span class="n">cbi</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">cmp</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                                <span class="n">cbi</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">cbi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_prnlines</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stoptm</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prn_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: lines in output</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prnlines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prnlines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">lns</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fatal_cnt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: fatal printout lines</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fatcnt</span></div>


<div class="viewcode-block" id="BackgroundProcess"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.BackgroundProcess">[docs]</a><span class="k">class</span> <span class="nc">BackgroundProcess</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0902</span>
    <span class="sd">&quot;&quot;&quot;a little util to spawn an executable and catch stdout / stderr via streams&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BackgroundProcess.__init__"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.BackgroundProcess.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">sout</span><span class="p">,</span> <span class="n">serr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=R1260</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initialize and start command</span>

<span class="sd">        :param Union[list,str] cmd: full command line</span>
<span class="sd">        :param str cwd: working dir of command</span>
<span class="sd">        :param stream sout: where to log stdout to</span>
<span class="sd">        :param stream serr: where to log stderr to</span>
<span class="sd">        :param dict kwargs: additional arguments</span>
<span class="sd">        :keyword \**kwargs:</span>
<span class="sd">            * *outchk* (``bool``): stdout check if subprocess is still running - tweak to let e.g. EDP com server run</span>
<span class="sd">            * *logger* (``Logger``): which logger object to use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outchk</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;outchk&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_excode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">MSWIN</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;creationflags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CREATE_NEW_PROCESS_GROUP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pdet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ecode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_starttm</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">xargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;inverse&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span> <span class="p">{},)]}</span>
            <span class="k">if</span> <span class="n">serr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">serr</span> <span class="o">=</span> <span class="n">sout</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_out</span> <span class="o">=</span> <span class="n">NonBlockingStreamReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sout</span><span class="p">,</span> <span class="o">**</span><span class="n">xargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_out</span> <span class="o">=</span> <span class="n">NonBlockingStreamReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sout</span><span class="p">,</span> <span class="o">**</span><span class="n">xargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="n">NonBlockingStreamReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">serr</span><span class="p">,</span> <span class="o">**</span><span class="n">xargs</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pdet</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;The system cannot find the file&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ecode</span> <span class="o">=</span> <span class="n">ERR_HPC_APPLICATION_NOT_LOCAL</span>
            <span class="n">serr</span><span class="p">(</span><span class="s2">&quot;exec error occured: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BackgroundProcess.close"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.BackgroundProcess.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send wm_close</span>

<span class="sd">        read a bug: https://bugs.python.org/issue33245</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">MSWIN</span><span class="p">:</span>
                <span class="n">hwnds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hwnds_for_pid</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">hwnds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;...sending WM_CLOSE to </span><span class="si">%d</span><span class="s2"> handles&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hwnds</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">hwnd</span> <span class="ow">in</span> <span class="n">hwnds</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># logger.info(&quot;window text: %d -&gt; &#39;%s&#39;&quot;, hwnd, GetWindowText(hwnd))</span>
                            <span class="n">PostMessage</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="n">WM_CLOSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">ex</span><span class="o">.</span><span class="n">args</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1400</span><span class="p">,</span> <span class="s1">&#39;PostMessage&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid window handle.&#39;</span><span class="p">,):</span>  <span class="c1"># already closed</span>
                                <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_kill_childs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pdet</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_kill_childs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pdet</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_kill_childs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>  <span class="c1"># pylint: disable=R1260</span>
        <span class="sd">&quot;&quot;&quot;issue a func with args to all childs of proc and lastly to proc itself&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">MSWIN</span><span class="p">:</span>
            <span class="n">funcs</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;send_signal&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">CTRL_BREAK_EVENT</span><span class="p">,),</span> <span class="s2">&quot;closing&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">logger</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">funcs</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;send_signal&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">SIGINT</span><span class="p">,),</span> <span class="s2">&quot;closing&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="n">logger</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">term</span><span class="p">:</span>
            <span class="n">funcs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s2">&quot;terminate&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="s2">&quot;terminating&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span> <span class="k">if</span> <span class="n">logger</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proc</span> <span class="ow">and</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">chp</span> <span class="ow">in</span> <span class="p">[</span><span class="n">proc</span><span class="p">]</span> <span class="o">+</span> <span class="n">proc</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2">&#39; with PID </span><span class="si">%d</span><span class="s2"> ...&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">chp</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">chp</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">chp</span><span class="p">,</span> <span class="n">func</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">NoSuchProcess</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;process </span><span class="si">%d</span><span class="s2"> already died&quot;</span><span class="p">,</span> <span class="n">chp</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

                <span class="n">wtm</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">EXIT_GRACE_TIME</span>
                <span class="k">while</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span> <span class="ow">and</span> <span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">wtm</span><span class="p">:</span>
                    <span class="n">try_sleep</span><span class="p">(</span><span class="mf">0.333</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;process ended&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="c1"># clean up, we don&#39;t mind more</span>
        <span class="c1"># self._proc = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ecode</span> <span class="o">=</span> <span class="n">ERR_OK</span>

    <span class="k">def</span> <span class="nf">_get_hwnds_for_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get HWNDs from PID</span>
<span class="sd">        taken essencially from http://timgolden.me.uk/python/win32_how_do_i/find-the-window-for-my-subprocess.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="n">hwnds</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;CB&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">IsWindowEnabled</span><span class="p">(</span><span class="n">hwnd</span><span class="p">):</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">found_pid</span> <span class="o">=</span> <span class="n">GetWindowThreadProcessId</span><span class="p">(</span><span class="n">hwnd</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">found_pid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
                    <span class="n">hwnds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hwnd</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">hwnds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
            <span class="n">EnumWindows</span><span class="p">(</span><span class="n">_callback</span><span class="p">,</span> <span class="n">hwnds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hwnds</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: indication whether process is running</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outchk</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">running</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="BackgroundProcess.wait"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.BackgroundProcess.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">inf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wait until process finishes&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">!=</span> <span class="n">inf</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">+=</span> <span class="n">time</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">try_sleep</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: the app itself</span>
<span class="sd">        :rtype: `Process`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">proc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: process instance</span>
<span class="sd">        :rtype: ``Process``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdet</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: PID of process</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">pid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exitcode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: exit code of application</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_excode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_excode</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ecode</span>

    <span class="nd">@exitcode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">exitcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;overwrite the real exitcode&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_excode</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prn_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: lines being printed</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lns</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span><span class="p">:</span>
            <span class="n">lns</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span><span class="o">.</span><span class="n">prn_lines</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">prn_lines</span> <span class="o">+</span> <span class="n">lns</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fatal_cnt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: lines being printed</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span><span class="o">.</span><span class="n">fatal_cnt</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">fatal_cnt</span> <span class="o">+</span> <span class="n">cnt</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wall_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: wall / real time</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">stoptm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="o">.</span><span class="n">stoptm</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starttm</span></div>


<div class="viewcode-block" id="WrapProc"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.WrapProc">[docs]</a><span class="k">class</span> <span class="nc">WrapProc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;wrap execution(s)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="WrapProc.__init__"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.WrapProc.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapers</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">streams</span><span class="p">,</span> <span class="n">hpc</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0912,R1260</span>
        <span class="sd">&quot;&quot;&quot;init and start all executables...&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wflag</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrappers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loggers</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapers</span><span class="p">,</span> <span class="n">StringTypes</span><span class="p">):</span>
            <span class="n">wrapers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="n">wrapers</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wrapers</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">StringTypes</span><span class="p">):</span>
                    <span class="n">wrapers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cmd&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">wrapers</span> <span class="o">=</span> <span class="p">[</span><span class="n">wrapers</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">exe</span> <span class="ow">in</span> <span class="n">wrapers</span><span class="p">:</span>
            <span class="n">clst</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cmd&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">clst</span><span class="p">:</span>  <span class="c1"># extract name for logger</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">replace_env_vars</span><span class="p">(</span><span class="n">hpc</span><span class="p">,</span> <span class="p">[</span><span class="n">exe</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cmd&quot;</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">clst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">):</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;python -u &quot;</span> <span class="o">+</span> <span class="n">cmd</span>

                <span class="c1"># setup logger and start process</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting wrapper &#39;</span><span class="si">%s</span><span class="s2">&#39; ...&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
                <span class="n">wlog</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">clst</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">streams</span><span class="p">,</span> <span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">] &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappers</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loggers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wlog</span><span class="p">)</span>

                <span class="n">cwd</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cwd&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;cwd&quot;</span> <span class="ow">in</span> <span class="n">exe</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">tout</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_TIME_WATCH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">exe</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;timeout&quot;</span> <span class="ow">in</span> <span class="n">exe</span> <span class="k">else</span> <span class="p">(</span><span class="n">MAX_TIME_WATCH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">3600</span>
                <span class="n">cbfnc</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="n">exe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;waitfor&quot;</span><span class="p">):</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;waitfor&quot;</span><span class="p">)</span>
                    <span class="n">cbfnc</span><span class="p">[</span><span class="n">recomp</span><span class="p">(</span><span class="n">txt</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cbwaiter</span><span class="p">,</span> <span class="n">txt</span><span class="p">,)</span>
                <span class="k">if</span> <span class="n">exe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;erroron&quot;</span><span class="p">):</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;erroron&quot;</span><span class="p">)</span>
                    <span class="n">cbfnc</span><span class="p">[</span><span class="n">recomp</span><span class="p">(</span><span class="n">txt</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cberror</span><span class="p">,</span> <span class="n">txt</span><span class="p">,)</span>

                <span class="n">pproc</span> <span class="o">=</span> <span class="n">BackgroundProcess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">wlog</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">wlog</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">cbfnc</span><span class="p">,</span> <span class="o">**</span><span class="n">exe</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cbfnc</span><span class="p">:</span>
                    <span class="n">mxwt</span> <span class="o">=</span> <span class="n">tout</span> <span class="o">+</span> <span class="n">time</span><span class="p">()</span>
                    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wflag</span> <span class="ow">and</span> <span class="n">pproc</span><span class="o">.</span><span class="n">running</span> <span class="ow">and</span> <span class="n">mxwt</span> <span class="o">&gt;</span> <span class="n">time</span><span class="p">():</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wflag</span> <span class="ow">and</span> <span class="n">mxwt</span> <span class="o">&gt;</span> <span class="n">time</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span> <span class="o">=</span> <span class="s2">&quot;max timeout of </span><span class="si">{:.0f}</span><span class="s2">s for wrapper reached to wait for indication!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tout</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">pproc</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span> <span class="o">=</span> <span class="s2">&quot;wrapper not running any longer, or didn&#39;t start at all!&quot;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_wrappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pproc</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span> <span class="o">=</span> <span class="s2">&quot;empty wrapper (no cmd) specified!&quot;</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:return self&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">exval</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get out: close apps&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">wrp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">wrp</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="n">wrp</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not running any more!&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loggers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exval</span><span class="p">,</span> <span class="n">HpcError</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exval</span><span class="o">.</span><span class="n">error</span> <span class="o">==</span> <span class="n">ERR_APPLICATION_WRAPPER</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">exval</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">close</span> <span class="o">=</span> <span class="fm">__exit__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return if all wrappers are still running&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">running</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrappers</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: number of wrappers</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrappers</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">failed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: failure desc, if any</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span>

    <span class="k">def</span> <span class="nf">_cbwaiter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;call back the waiter function&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wflag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stdout line detected to continue: &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wflag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_cberror</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;call back for errors&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wflag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;stdout line detected to break: &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span> <span class="o">=</span> <span class="n">line</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wflag</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="LogTimer"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.LogTimer">[docs]</a><span class="k">class</span> <span class="nc">LogTimer</span><span class="p">(</span><span class="n">Timer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;derived for logging&quot;&quot;&quot;</span>

<div class="viewcode-block" id="LogTimer.__init__"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.LogTimer.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;overload&quot;&quot;&quot;</span>
        <span class="n">Timer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timed_out</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LogTimer.run"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.LogTimer.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;run it&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timed_out</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="CloudBlob"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.CloudBlob">[docs]</a><span class="k">class</span> <span class="nc">CloudBlob</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;encapsulates Win and Linux parts&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CloudBlob.__init__"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.CloudBlob.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">blob</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set up the blob&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span> <span class="o">=</span> <span class="n">BlobClient</span><span class="o">.</span><span class="n">from_connection_string</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">blob</span><span class="p">)</span></div>
        <span class="c1"># else:</span>
        <span class="c1">#     self._blob = BlobClient(connection_string=conn)</span>
        <span class="c1">#     self._xargs = {&quot;container_name&quot;: cont, &quot;blob_name&quot;: blob}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the props&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span><span class="o">.</span><span class="n">get_blob_properties</span><span class="p">()</span>
        <span class="c1"># return self._blob.get_blob_properties(**self._xargs).properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the file size&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
        <span class="c1"># return self.properties.content_length</span>

<div class="viewcode-block" id="CloudBlob.download"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.CloudBlob.download">[docs]</a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;download blob to fpath&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">blob</span><span class="p">:</span>
            <span class="n">strm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blob</span><span class="o">.</span><span class="n">download_blob</span><span class="p">()</span>  <span class="c1"># offset=0, length=16384)</span>
            <span class="n">strm</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span></div></div>
        <span class="c1"># else:</span>
        <span class="c1">#     self._blob.get_blob_to_path(file_path=fpath, **self._xargs)</span>


<div class="viewcode-block" id="timeit"><a class="viewcode-back" href="../../../hpc.core.html#hpc.core.app_utils.timeit">[docs]</a><span class="k">def</span> <span class="nf">timeit</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;decorate to measure function calls&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_timeit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">frmt_str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;timeit_frmt&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;timeit_frmt&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">startm</span> <span class="o">=</span> <span class="n">default_timer</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frmt_str</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">frmt_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">default_timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">startm</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_timeit</span></div>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HPC 2.12.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, VDS.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.1.
    </div>
  </body>
</html>