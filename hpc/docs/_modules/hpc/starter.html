
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=cp1252" />
    <title>hpc.starter</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="index" title="Index" href="../../genindex.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">HPC 2.12.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for hpc.starter</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python3 -u</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">starter.py</span>
<span class="sd">----------</span>

<span class="sd">Script to be used to start a CMD Line Application in a HPC task.</span>

<span class="sd">Features:</span>
<span class="sd">    - moving of task result and log data back to the server</span>
<span class="sd">    - app watcher checking if the application is idle</span>
<span class="sd">    - graceful exit of GUI applications on task cancellation</span>
<span class="sd">    - evaluation of MTS return code and check for crash-dumps</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=C0302,R0912,R0915,R1260</span>
<span class="c1"># C0413,E1101,E0611,W0702,W1201,W1202</span>
<span class="c1"># - import Python Modules ----------------------------------------------------------------------------------------------</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">makedirs</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">unlink</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">getcwd</span><span class="p">,</span> <span class="n">chmod</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">getsize</span><span class="p">,</span> <span class="n">splitext</span>
<span class="kn">from</span> <span class="nn">stat</span> <span class="kn">import</span> <span class="n">S_IEXEC</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span><span class="p">,</span> <span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span> <span class="n">SUPPRESS</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">packaging.version</span> <span class="kn">import</span> <span class="n">Version</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">distutils.version</span> <span class="kn">import</span> <span class="n">LooseVersion</span> <span class="k">as</span> <span class="n">Version</span>
<span class="kn">from</span> <span class="nn">platform</span> <span class="kn">import</span> <span class="n">architecture</span><span class="p">,</span> <span class="n">python_version_tuple</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">match</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="nb">compile</span> <span class="k">as</span> <span class="n">recomp</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">gethostname</span>
<span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getuser</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryFile</span><span class="p">,</span> <span class="n">SpooledTemporaryFile</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">mktime</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="kn">import</span> <span class="n">print_exc</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">cpu_count</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>
<span class="c1"># from requests import post</span>
<span class="kn">from</span> <span class="nn">psutil</span> <span class="kn">import</span> <span class="n">pid_exists</span><span class="p">,</span> <span class="n">virtual_memory</span><span class="p">,</span> <span class="n">cpu_percent</span><span class="p">,</span> <span class="n">NoSuchProcess</span><span class="p">,</span> <span class="n">disk_usage</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">inf</span>
<span class="kn">from</span> <span class="nn">pytz</span> <span class="kn">import</span> <span class="n">UTC</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">PY2</span>
<span class="kn">from</span> <span class="nn">simplejson</span> <span class="kn">import</span> <span class="n">load</span>

<span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
    <span class="nb">range</span> <span class="o">=</span> <span class="n">xrange</span>  <span class="c1"># pylint: disable=W0622,C0103,E0602</span>
    <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
    <span class="n">DEVNULL</span> <span class="o">=</span> <span class="n">PIPE</span>
    <span class="n">NoSuchFile</span> <span class="o">=</span> <span class="ne">IOError</span>
    <span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">StringTypes</span>
    <span class="n">EPOCH</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span><span class="p">,</span> <span class="n">DEVNULL</span>  <span class="c1"># pylint: disable=C0412</span>
    <span class="n">NoSuchFile</span> <span class="o">=</span> <span class="ne">FileNotFoundError</span>
    <span class="n">StringTypes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">,)</span>

<span class="n">MSWIN</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span>
<span class="k">if</span> <span class="n">MSWIN</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">signal</span><span class="p">,</span> <span class="n">SIGBREAK</span> <span class="k">as</span> <span class="n">SIG_END</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">,</span> <span class="n">SIGINT</span><span class="p">,</span> <span class="n">SIGSEGV</span>
    <span class="kn">from</span> <span class="nn">win32api</span> <span class="kn">import</span> <span class="n">OpenProcess</span><span class="p">,</span> <span class="n">CloseHandle</span><span class="p">,</span> <span class="n">TerminateProcess</span>
    <span class="kn">from</span> <span class="nn">win32file</span> <span class="kn">import</span> <span class="n">GetFileAttributesW</span><span class="p">,</span> <span class="n">CopyFileEx</span>
    <span class="kn">from</span> <span class="nn">win32con</span> <span class="kn">import</span> <span class="n">FILE_ATTRIBUTE_OFFLINE</span>
    <span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">WinError</span>
<span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
    <span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">signal</span><span class="p">,</span> <span class="n">SIGHUP</span> <span class="k">as</span> <span class="n">SIG_END</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">,</span> <span class="n">SIGINT</span><span class="p">,</span> <span class="n">SIGSEGV</span>  <span class="c1"># pylint: disable=C0412</span>

    <span class="k">class</span> <span class="nc">WinError</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0903</span>
        <span class="sd">&quot;&quot;&quot;overload for Linux&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;do nothing&quot;&quot;&quot;</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">strerror</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;no desc&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;no description available&quot;</span>

<span class="c1"># - import HPC modules -------------------------------------------------------------------------------------------------</span>
<span class="n">HPC_FOLDER</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="sa">r</span><span class="s2">&quot;..&quot;</span><span class="p">))</span>
<span class="k">if</span> <span class="n">HPC_FOLDER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPC_FOLDER</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">hpc</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">hpc.core.app_utils</span> <span class="kn">import</span> <span class="n">BackgroundProcess</span><span class="p">,</span> <span class="n">HpcArgumentParser</span><span class="p">,</span> <span class="n">ArgumentParserError</span><span class="p">,</span> <span class="n">try_sleep</span><span class="p">,</span> <span class="n">MonDataCollector</span><span class="p">,</span> \
    <span class="n">WrapProc</span><span class="p">,</span> <span class="n">replace_env_vars</span><span class="p">,</span> <span class="n">LogTimer</span><span class="p">,</span> <span class="n">file_version</span><span class="p">,</span> <span class="n">timeit</span><span class="p">,</span> <span class="n">CloudBlob</span><span class="p">,</span> <span class="n">IO_CNT</span><span class="p">,</span> <span class="n">PROC_TIME</span><span class="p">,</span> \
    <span class="n">REPORT_WAIT_TIME_INITIAL</span><span class="p">,</span> <span class="n">REPORT_WAIT_TIME_CYCLE</span><span class="p">,</span> <span class="n">MAX_TIME_WATCH</span><span class="p">,</span> <span class="n">EXIT_GRACE_TIME</span>
<span class="kn">from</span> <span class="nn">hpc.core.robocopy</span> <span class="kn">import</span> <span class="n">Robocopy</span>
<span class="kn">from</span> <span class="nn">hpc.core.dicts</span> <span class="kn">import</span> <span class="n">JobDict</span><span class="p">,</span> <span class="n">DefDict</span><span class="p">,</span> <span class="n">TOUT_DIR</span><span class="p">,</span> <span class="n">TLOG_DIR</span><span class="p">,</span> <span class="n">BSIG_CHK</span><span class="p">,</span> <span class="n">WRAP_EXE</span><span class="p">,</span> <span class="n">CNCL_CMD</span><span class="p">,</span> <span class="n">USR_EXMAP</span><span class="p">,</span> \
    <span class="n">NOTIFY_START</span><span class="p">,</span> <span class="n">NOTIFY_STOP</span>
<span class="kn">from</span> <span class="nn">hpc.core.hpc_defs</span> <span class="kn">import</span> <span class="n">JobUnitType</span>
<span class="kn">from</span> <span class="nn">hpc.core.tds</span> <span class="kn">import</span> <span class="n">head_name</span><span class="p">,</span> <span class="n">server_path</span><span class="p">,</span> <span class="n">replace_server_path</span><span class="p">,</span> <span class="n">resolve_ip</span><span class="p">,</span> \
    <span class="n">HPC_STORAGE_MAP</span><span class="p">,</span> <span class="n">LOC_HEAD_MAP</span><span class="p">,</span> <span class="n">AZR_BLOB_STX</span><span class="p">,</span> <span class="n">AZR_CONN_STR</span><span class="p">,</span> <span class="n">AZR_ACC_KEYS</span>
<span class="kn">from</span> <span class="nn">hpc.core.path</span> <span class="kn">import</span> <span class="n">linux2win</span><span class="p">,</span> <span class="n">win2linux</span><span class="p">,</span> <span class="n">on_tree_error</span>
<span class="kn">from</span> <span class="nn">hpc.core.convert</span> <span class="kn">import</span> <span class="n">human_size</span>
<span class="kn">from</span> <span class="nn">hpc.core.logger</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">hpc.core.exitcodes</span> <span class="kn">import</span> <span class="n">ExitCodes</span>
<span class="kn">from</span> <span class="nn">hpc.core</span> <span class="kn">import</span> <span class="n">proc_vals</span> <span class="k">as</span> <span class="n">pvs</span>
<span class="kn">from</span> <span class="nn">hpc.rdb.env_data</span> <span class="kn">import</span> <span class="n">EnvData</span><span class="p">,</span> <span class="n">daemon_cmd</span>
<span class="kn">from</span> <span class="nn">hpc.mts.mts_check</span> <span class="kn">import</span> <span class="n">mts_log_check</span><span class="p">,</span> <span class="n">check_mts_ini</span>
<span class="kn">from</span> <span class="nn">hpc.mts.bsig_check</span> <span class="kn">import</span> <span class="n">bsig_check</span>
<span class="kn">from</span> <span class="nn">hpc.core.error</span> <span class="kn">import</span> <span class="n">HpcError</span><span class="p">,</span> <span class="n">ERR_OK</span><span class="p">,</span> <span class="n">EXIT_MAP</span><span class="p">,</span> <span class="n">MTS_LOOKUP_EXITCODE</span><span class="p">,</span> <span class="n">MTS_LOOKUP_EXITMSG</span><span class="p">,</span> <span class="n">ERR_APPLICATION_HANG</span><span class="p">,</span> \
    <span class="n">ERR_INFRASTRUCTURE_FAILED_TO_COPY_DATA</span><span class="p">,</span> <span class="n">ERR_HPC_APPLICATION_NOT_LOCAL</span><span class="p">,</span> <span class="n">ERR_HPC_APPLICATION_NOT_FOUND</span><span class="p">,</span> \
    <span class="n">ERR_APPLICATION_CPU_IDLE</span><span class="p">,</span> <span class="n">ERR_APPLICATION_IO_IDLE</span><span class="p">,</span> <span class="n">ERR_APPLICATION_PRN_IDLE</span><span class="p">,</span> <span class="n">ERR_APPLICATION_TIMEOUT</span><span class="p">,</span> \
    <span class="n">ERR_MTS_OLD_DLL_DETECTED</span><span class="p">,</span> <span class="n">ERR_HPC_WRONG_ARG</span><span class="p">,</span> <span class="n">ERR_HPC_SCRIPT_MALFUNCTION</span><span class="p">,</span> <span class="n">ERR_HPC_DATABASE</span><span class="p">,</span> \
    <span class="n">ERR_INFRASTRUCTURE_UNSPECIFIC_ERROR_FOUND</span><span class="p">,</span> <span class="n">ERR_INFRASTRUCTURE_RECORDING_UNAVAILABLE</span><span class="p">,</span> <span class="n">ERR_INFRASTRUCTURE_GPU_EXEC</span><span class="p">,</span> \
    <span class="n">ERR_MTS_MEM_LEAK_FOUND</span><span class="p">,</span> <span class="n">ERR_INFRASTRUCTURE_RECORDING_ARCHIVED</span><span class="p">,</span> <span class="n">ERR_MTS_UNSPECIFIED_ERROR_FOUND</span><span class="p">,</span> \
    <span class="n">ERR_INFRASTRUCTURE_FAILED_TO_CREATE_DATA</span><span class="p">,</span> <span class="n">ERR_HPC_INTERNAL_ERROR</span><span class="p">,</span> <span class="n">ERR_HPC_USER_CANCEL_TASK_DETECTED</span><span class="p">,</span> \
    <span class="n">ERR_APPLICATION_UNSPECIFIED_ERROR_FOUND</span><span class="p">,</span> <span class="n">ERR_APPLICATION_LOW_MEM</span><span class="p">,</span> <span class="n">ERR_APPLICATION_LOW_CPU</span><span class="p">,</span> \
    <span class="n">ERR_APPLICATION_HIGH_MEM</span><span class="p">,</span> <span class="n">ERR_APPLICATION_FATAL</span><span class="p">,</span> <span class="n">ERR_PYTHON_UNSPECIFIED_ERROR_FOUND</span><span class="p">,</span> \
    <span class="n">ERR_HPC_UNSPECIFIED_ERROR_FOUND</span><span class="p">,</span> <span class="n">ERR_APPLICATION_WRAPPER</span><span class="p">,</span> <span class="n">ERR_HPC_PID_INVALID</span><span class="p">,</span> <span class="n">ERR_APP_ERR_NETWORK_UNAVAILABLE</span><span class="p">,</span> \
    <span class="n">ERR_HPC_LOW_DISK_SPACE</span>

<span class="c1"># - defines ------------------------------------------------------------------------------------------------------------</span>
<span class="n">D_DRIVE</span> <span class="o">=</span> <span class="s2">&quot;D:&quot;</span> <span class="k">if</span> <span class="n">MSWIN</span> <span class="k">else</span> <span class="s2">&quot;/var/hpc&quot;</span>

<span class="n">DEBUG_ARGS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mts_exe&quot;</span><span class="p">,</span> <span class="s2">&quot;mem_max&quot;</span><span class="p">]</span>

<span class="n">SIGNAMES</span> <span class="o">=</span> <span class="n">DefDict</span><span class="p">(</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">SIG_END</span><span class="p">):</span> <span class="s2">&quot;SIGBREAK&quot;</span> <span class="k">if</span> <span class="n">MSWIN</span> <span class="k">else</span> <span class="s2">&quot;SIGHUB&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">):</span> <span class="s2">&quot;SIGTERM&quot;</span><span class="p">,</span>
                               <span class="nb">int</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">):</span> <span class="s2">&quot;SIGINT&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">):</span> <span class="s2">&quot;SIGSEGV&quot;</span><span class="p">})</span>

<span class="n">OTHER</span> <span class="o">=</span> <span class="s2">&quot;OTHER&quot;</span>

<span class="n">FILE_CHECKS</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">sys</span><span class="se">\\</span><span class="s2">rawrecfilereader.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;2.6.260.31&quot;</span><span class="p">],</span>
               <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">cfg</span><span class="se">\\</span><span class="s2">..</span><span class="se">\\</span><span class="s2">dll</span><span class="se">\\</span><span class="s2">sim</span><span class="se">\\</span><span class="s2">sim_vfb.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;5.83.0.3264&quot;</span><span class="p">],</span>
               <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">cfg</span><span class="se">\\</span><span class="s2">..</span><span class="se">\\</span><span class="s2">dll</span><span class="se">\\</span><span class="s2">algo</span><span class="se">\\</span><span class="s2">sim</span><span class="se">\\</span><span class="s2">sim_vfb.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;5.83.0.3264&quot;</span><span class="p">],</span>
               <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">cfg</span><span class="se">\\</span><span class="s2">..</span><span class="se">\\</span><span class="s2">dll</span><span class="se">\\</span><span class="s2">sim</span><span class="se">\\</span><span class="s2">sim_vfb_x64.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;5.83.0.3264&quot;</span><span class="p">],</span>
               <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">cfg</span><span class="se">\\</span><span class="s2">..</span><span class="se">\\</span><span class="s2">dll</span><span class="se">\\</span><span class="s2">algo</span><span class="se">\\</span><span class="s2">sim</span><span class="se">\\</span><span class="s2">sim_vfb_x64.dll&quot;</span><span class="p">,</span> <span class="s2">&quot;5.83.0.3264&quot;</span><span class="p">]]</span>


<span class="c1"># - starter class ------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="AppStarter"><a class="viewcode-back" href="../../hpc.html#hpc.starter.AppStarter">[docs]</a><span class="k">class</span> <span class="nc">AppStarter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0902</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Application Handler / HPC executor for:</span>

<span class="sd">    - starting the applications,</span>
<span class="sd">    - copying results from the apps back to the server,</span>
<span class="sd">    - starting the HPC watchdog (check cpu and io usage),</span>
<span class="sd">    - interrupt handling like CTRL+C (Cancel Command)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AppStarter.__init__"><a class="viewcode-back" href="../../hpc.html#hpc.starter.AppStarter.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;initialize the executor&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wargs&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fastwatch&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;wdog_init&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;wdog_loop&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">streamer</span> <span class="o">=</span> <span class="n">SpooledTemporaryFile</span><span class="p">(</span><span class="n">max_size</span><span class="o">=</span><span class="mi">67108864</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;hpc_&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">streamer</span><span class="p">,</span> <span class="kc">True</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">head_name</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sched&#39;</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stdout&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;HPC exec:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cpu_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_cpu_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">environ</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_ret</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_io</span> <span class="o">=</span> <span class="n">ERR_OK</span><span class="p">,</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wdog_log</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errmons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proclog</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datafolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempfolder</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_rec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">networkpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_taskid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_envhandler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cwd</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;cwd&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span> <span class="o">=</span> <span class="n">JobDict</span><span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwd</span><span class="p">,</span> <span class="s2">&quot;hpc&quot;</span><span class="p">,</span> <span class="s2">&quot;job.json&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">head_name</span><span class="p">(</span><span class="n">OTHER</span><span class="p">)</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sched&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                          <span class="k">else</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sched&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span> <span class="o">=</span> <span class="n">ExitCodes</span><span class="p">(</span><span class="n">prios</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">prios</span><span class="p">,</span> <span class="n">unfailing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">unfailing</span><span class="p">,</span>
                                   <span class="n">ignore_codes</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;ignore_codes&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span> <span class="o">=</span> <span class="n">ExitCodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">jobid</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CCP_JOBID&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">jobid</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;discrepancy on job&#39;s Ident!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">ERR_HPC_PID_INVALID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
        <span class="c1"># self._sqlitedb = join(self._cwd, &quot;hpc.sqlite&quot;)</span>
        <span class="c1"># try:</span>
        <span class="c1">#     self._exitcode = ExitCodes(db=self._sqlitedb, unfailing=self._jobdb.unfailing,</span>
        <span class="c1">#                                ignore_codes=getattr(self._jobdb, &quot;ignore_codes&quot;, []))</span>
        <span class="c1"># except Exception:  # seems backup sqlite cannot be used</span>
        <span class="c1">#     self._sqlitedb = None</span>
        <span class="c1">#     self._exitcode = ExitCodes(unfailing=self._jobdb.unfailing,</span>
        <span class="c1">#                                ignore_codes=getattr(self._jobdb, &quot;ignore_codes&quot;, []))</span>

        <span class="k">if</span> <span class="n">head_name</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbase</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">HPC_STORAGE_MAP</span><span class="p">[</span><span class="n">head_name</span><span class="p">()][</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbase</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwd</span><span class="p">,</span> <span class="s2">&quot;hpc.sqlite&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rec_ip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_py</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_docker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker_err</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ERR_OK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_docker_msgs</span> <span class="o">=</span> <span class="p">{</span><span class="n">recomp</span><span class="p">(</span><span class="s2">&quot;stderr: nvidia-container-cli: initialization error: nvml &quot;</span>
                                    <span class="s2">&quot;error: driver/library version mismatch: unknown&quot;</span><span class="p">):</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_docker_exit</span><span class="p">,</span> <span class="n">ERR_INFRASTRUCTURE_GPU_EXEC</span><span class="p">,)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mts_cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mts_check_cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># self._verbose = 0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">DEBUG_ARGS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wargs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;just self&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;clean up 4 testing purposes&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamer</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">[:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">streamer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">clear</span> <span class="o">=</span> <span class="fm">__exit__</span>

    <span class="k">def</span> <span class="nf">_create_std_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create needed standard folders and files for the task to run being tracked</span>

<span class="sd">        :param str part: this part is either start or stop</span>
<span class="sd">        :return: success status</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">:</span>
            <span class="c1"># create standard folders which are available for every application</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwd</span><span class="p">),</span> <span class="s1">&#39;2_Output&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">)</span>

            <span class="c1"># check if task folder exist</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;creating local task folder: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># create output folder for log files</span>
                <span class="n">makedirs</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">))</span>

                <span class="c1"># create output folder for data files</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datafolder</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
                <span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datafolder</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tempfolder</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
                <span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempfolder</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unable to create output folders: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">ERR_INFRASTRUCTURE_FAILED_TO_CREATE_DATA</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">netp</span><span class="p">,</span> <span class="n">errmsgs</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networkpath</span><span class="p">,</span> <span class="s1">&#39;2_Output&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">),</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fldr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">netp</span><span class="p">,</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TMP&quot;</span><span class="p">),):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">makedirs</span><span class="p">(</span><span class="n">fldr</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">errmsgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">netp</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H_%M_%S&#39;</span><span class="p">),</span> <span class="n">part</span><span class="p">))</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;created file </span><span class="si">%s</span><span class="s2"> successfully&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t create </span><span class="si">%s</span><span class="s2">, due to </span><span class="si">%s</span><span class="s2">!&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">errmsgs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;addon message: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">ERR_INFRASTRUCTURE_FAILED_TO_CREATE_DATA</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_create_procdumps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create a procdump&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MSWIN</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proclog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proclog</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;ProcDump:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">)</span>

        <span class="n">avail</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># workaround for missing procdump rollout</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">avail</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting dump </span><span class="si">%d</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">dmp</span> <span class="o">=</span> <span class="n">BackgroundProcess</span><span class="p">([</span><span class="sa">r</span><span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">LegacyApp</span><span class="se">\\</span><span class="s2">HpcApps</span><span class="se">\\</span><span class="s2">procdump.exe&quot;</span><span class="p">,</span> <span class="s2">&quot;-accepteula&quot;</span><span class="p">,</span> <span class="s2">&quot;-ma&quot;</span><span class="p">,</span>
                                         <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span><span class="p">),</span>
                                         <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;mts_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.dmp&#39;</span>
                                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H.%M.%S&#39;</span><span class="p">)))],</span>
                                        <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proclog</span><span class="o">.</span><span class="n">warning</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_proclog</span><span class="p">,</span>
                                        <span class="nb">filter</span><span class="o">=</span><span class="n">recomp</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*Dump\s\d\s.*&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">dmp</span><span class="o">.</span><span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_proclog</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no ProcDump.exe available!&quot;</span><span class="p">)</span>
                    <span class="n">avail</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dmp</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">try_sleep</span><span class="p">(</span><span class="mf">0.333</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_proclog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;proc dump didn&#39;t finish, killing it now...&quot;</span><span class="p">)</span>
                        <span class="n">dmp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">5.</span><span class="p">:</span>
                <span class="n">try_sleep</span><span class="p">(</span><span class="mf">0.333</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">avail</span>

    <span class="k">def</span> <span class="nf">_create_cdb_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create debug info&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MSWIN</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
            <span class="k">return</span>

        <span class="n">logfn</span> <span class="o">=</span> <span class="s2">&quot;mts_cdb_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H.%M.%S&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;creating cdb log: ....</span><span class="se">\\</span><span class="s2">log</span><span class="se">\\</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">logfn</span><span class="p">)</span>
        <span class="n">cdb</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\LegacyApp\HpcApps\cdb.exe -p </span><span class="si">{}</span><span class="s1"> -c &quot;~*k;.detach;q&quot; -logo </span><span class="si">{}</span><span class="s1">&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">logfn</span><span class="p">)),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
            <span class="n">try_sleep</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
                <span class="n">cdb</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cdb</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;cdb log takes too long, quitting it!&quot;</span><span class="p">)</span>
            <span class="n">cdb</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_mail_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">send</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mail user about task status&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">send</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">mail</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">daemon_cmd</span><span class="p">(</span><span class="s2">&quot;mail;</span><span class="si">{0}</span><span class="s2">;Your task </span><span class="si">{2}</span><span class="s2">.</span><span class="si">{3}</span><span class="s2"> is now in the &#39;</span><span class="si">{5}</span><span class="s2">&#39; state;&quot;</span>
                         <span class="s2">&quot;Notification from cluster </span><span class="si">{1}</span><span class="s2">: Task Id: </span><span class="si">{2}</span><span class="s2">.</span><span class="si">{3}</span><span class="s2"> Name: </span><span class="si">{4}</span><span class="s2"> State: </span><span class="si">{5}</span><span class="s2">&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">mail</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_node</span><span class="p">)</span>

        <span class="n">log</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">,)</span> <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="s2">&quot;ERR&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="s2">&quot;sent&quot;</span><span class="p">,)</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;notification email to </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">mail</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_rm_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the error is due to an access error (read only file)</span>
<span class="sd">        it attempts to add write permission and then retries.</span>

<span class="sd">        If the error is for another reason it re-raises the error.</span>

<span class="sd">        Usage : ``shutil.rmtree(path, onerror=onerror)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;folder &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">on_tree_error</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_copy_delete_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;move data files from local task directory to network location.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempfolder</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">return</span>

        <span class="c1"># first delete tmp folder to prevent copying it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;deleting temp folder: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempfolder</span><span class="p">)</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempfolder</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_rm_error</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;moving data results back...&#39;</span><span class="p">)</span>
        <span class="c1"># move results to network from d:\\data\\%JobName%\\2_Output\\%TaskName%\\data</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datafolder</span>

        <span class="c1"># sync to primary job&#39;s output folder</span>
        <span class="n">robo</span> <span class="o">=</span> <span class="n">Robocopy</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">wait</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;robo_wait&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">retry</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;robo_retry&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                        <span class="n">comp_pat</span><span class="o">=</span><span class="s2">&quot;*.dmp&quot;</span><span class="p">,</span> <span class="n">errmon</span><span class="o">=</span><span class="s2">&quot;errmon_*.xlog&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;Failed&quot;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">stat</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">orig_loc</span><span class="p">:</span>
            <span class="c1"># a masterjob is copied back to \\&lt;orig_server&gt;\hpc\HPC_output\&lt;masterid&gt;_&lt;jobname&gt;\&lt;exec_head&gt;</span>
            <span class="c1"># instead of                    \\&lt;exec_server&gt;\hpc\&lt;exec_head&gt;\&lt;jobid&gt;_&lt;jobname&gt;\2_Output</span>
            <span class="n">orig_head</span> <span class="o">=</span> <span class="n">LOC_HEAD_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">orig_loc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;OTHER&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">outfldr</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">server_path</span><span class="p">(</span><span class="n">orig_head</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;HPC_output&#39;</span><span class="p">,</span>
                                   <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">masterid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">name</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_robocopy</span><span class="p">(</span><span class="n">robo</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">outfldr</span><span class="p">,</span> <span class="s1">&#39;_data&#39;</span><span class="p">),</span> <span class="n">join</span><span class="p">(</span><span class="n">outfldr</span><span class="p">,</span> <span class="n">head_name</span><span class="p">(</span><span class="n">OTHER</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ofldr</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networkpath</span><span class="p">,</span> <span class="s1">&#39;2_Output&#39;</span><span class="p">)</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ofldr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;task_out&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;_data&#39;</span><span class="p">)</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">TOUT_DIR</span><span class="p">,</span> <span class="n">outdir</span><span class="p">)</span>
            <span class="n">logdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">TLOG_DIR</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">ofldr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_robocopy</span><span class="p">(</span><span class="n">robo</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">logdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_errmons</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">\?</span><span class="se">\\</span><span class="s2">UNC</span><span class="se">\\</span><span class="s2">(.*)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">\1&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">robo</span><span class="o">.</span><span class="n">errmons</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_robocopy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robo</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">tsk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;copy the stuff&quot;&quot;&quot;</span>
        <span class="n">error</span><span class="p">,</span> <span class="n">overwrote</span> <span class="o">=</span> <span class="n">robo</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

        <span class="c1"># filter return code of robocopy after real error</span>
        <span class="k">if</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;robocopy finished with </span><span class="si">%d</span><span class="s1"> errors&#39;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">ERR_INFRASTRUCTURE_FAILED_TO_COPY_DATA</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">overwrote</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;robocopy overwrote </span><span class="si">%d</span><span class="s1"> files on output data folder&#39;</span><span class="p">,</span> <span class="n">overwrote</span><span class="p">)</span>
            <span class="c1"># uncomment when algo Jenkins was fixed</span>
            <span class="c1"># self._exitcode(ERR_INFRASTRUCTURE_DATA_OUTPUT_OVERWRITE)</span>

        <span class="c1"># copy MTS log folder back to network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;move other folders back to network...&#39;</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">robo</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">,</span> <span class="n">tsk</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;moved </span><span class="si">%s</span><span class="s1"> in summary&#39;</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">robo</span><span class="o">.</span><span class="n">bytes_written</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">ERR_INFRASTRUCTURE_FAILED_TO_COPY_DATA</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_docker_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;support the docker specific exitcode from message parsing&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_docker_err</span> <span class="o">=</span> <span class="n">code</span>

<div class="viewcode-block" id="AppStarter.cancel_handler"><a class="viewcode-back" href="../../hpc.html#hpc.starter.AppStarter.cancel_handler">[docs]</a>    <span class="k">def</span> <span class="nf">cancel_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;we&#39;re getting canceled&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">signum</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;already terminating (</span><span class="si">%d</span><span class="s2">), repeated signal: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span><span class="p">,</span> <span class="n">signum</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;frame = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">signum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;signal </span><span class="si">%d</span><span class="s2">=</span><span class="si">%s</span><span class="s2"> received!&quot;</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">SIGNAMES</span><span class="p">[</span><span class="n">signum</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">signum</span> <span class="o">==</span> <span class="n">SIGSEGV</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">ERR_HPC_UNSPECIFIED_ERROR_FOUND</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">ERR_HPC_USER_CANCEL_TASK_DETECTED</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># can only happen when not loaded yet...</span>
                <span class="k">pass</span>
            <span class="c1"># under Windows, SIGINT does not work</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># terminate app process if running</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">running</span> <span class="ow">or</span> <span class="n">pid_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span><span class="p">):</span>  <span class="c1"># pylint: disable=R1702</span>
            <span class="n">procdump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;procdump&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> \
                       <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_ret</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ERR_APPLICATION_CPU_IDLE</span><span class="p">,</span> <span class="n">ERR_APPLICATION_IO_IDLE</span><span class="p">,</span>
                                                   <span class="n">ERR_APPLICATION_TIMEOUT</span><span class="p">)</span>
            <span class="n">avail</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">signum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">procdump</span><span class="p">:</span>  <span class="c1"># we need to terminate as timeout occurred (e.g. -301) and create a dump</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_cdb_info</span><span class="p">()</span>
                    <span class="n">avail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_procdumps</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception on closing program!&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;waiting a bit for client to close down...&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">procdump</span> <span class="ow">and</span> <span class="n">avail</span> <span class="ow">and</span> <span class="n">signum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_procdumps</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">EXIT_GRACE_TIME</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;trying to terminate now...&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">handle</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span><span class="p">)</span>
                        <span class="n">TerminateProcess</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ERR_APPLICATION_HANG</span><span class="p">)</span>
                        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">EXIT_GRACE_TIME</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;shutdown completed.&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_APPLICATION_HANG</span><span class="p">)</span>
                        <span class="n">try_sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;termination failed!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;shutdown completed within grace time.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;process didn&#39;t exit yet, this shouldn&#39;t happen!!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_HPC_SCRIPT_MALFUNCTION</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;process exit code: </span><span class="si">{}</span><span class="s1"> (hex: </span><span class="si">{:08x}</span><span class="s1">)&#39;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exit successful (exit code: </span><span class="si">%d</span><span class="s2">).&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_start_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arglist</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">wraps</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        start application in a separate process.</span>

<span class="sd">        :param list arglist: complete commandline call to start the new process</span>
<span class="sd">        :param str cwd:      current working directory</span>
<span class="sd">        :param list wraps:   number of wrappers</span>
<span class="sd">        :param dict kwargs:  pass through for BackgroundProcess init</span>

<span class="sd">        :return: rec on local disk</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        :raises HpcError: if azure libs are not installed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">localrec</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">exe</span> <span class="o">=</span> <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arglist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;[0] &quot;</span> <span class="k">if</span> <span class="n">wraps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># check if application to start is local.</span>
        <span class="k">if</span> <span class="n">exe</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_HPC_APPLICATION_NOT_LOCAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Code: </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>

        <span class="c1"># prepare command line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_py</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_docker</span><span class="p">,</span> <span class="n">pargs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">app</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">):</span>
            <span class="n">em</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arglist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">arglist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">em</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;-m&quot;</span><span class="p">:</span>
                    <span class="n">em</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">em</span><span class="p">:</span>
                    <span class="n">app</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">app</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">):</span>
                    <span class="n">app</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">app</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_py</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">MSWIN</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arglist</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;VIRTUAL_ENV&quot;</span><span class="p">):</span>
                <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\\</span><span class="s2">Scripts</span><span class="se">\\</span><span class="s2">python.exe&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;VIRTUAL_ENV&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">base</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;measapp.exe&quot;</span><span class="p">,</span> <span class="s2">&quot;sil_lite.exe&quot;</span><span class="p">,):</span>
            <span class="n">app</span> <span class="o">=</span> <span class="s2">&quot;MTS&quot;</span> <span class="k">if</span> <span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span> <span class="k">else</span> <span class="s2">&quot;SilLite&quot;</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">app</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>  <span class="c1"># , color=&quot;olive&quot;)</span>
            <span class="n">pargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="n">recomp</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;.*ExtMeasurePointer\.__del__&#39;|.*Closing\sconnection.*&quot;</span><span class="p">),</span> <span class="s2">&quot;inverse&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mts_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;docker&quot;</span><span class="p">,</span> <span class="s2">&quot;docker.exe&quot;</span><span class="p">,</span> <span class="s2">&quot;docker.bat&quot;</span><span class="p">]:</span>  <span class="c1"># bat is inside for testing purposes</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--name&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;name of docker&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_docker</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">pargs</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker_msgs</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># ignore index/parsing errors</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;unable to find name of docker, or none given.&quot;</span><span class="p">)</span>

            <span class="n">app</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">base</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">base</span> <span class="k">else</span> <span class="n">base</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">app</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;foobar:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

        <span class="k">if</span> <span class="n">MSWIN</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;local_rec&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span><span class="p">:</span>  <span class="c1"># pylint: disable=R1702</span>
            <span class="c1"># with NamedMutex(&quot;local_copy&quot;, True):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arglist</span><span class="p">):</span>  <span class="c1"># pylint: disable=R1702</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-lr&#39;</span><span class="p">):</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># strip &quot;-lr&quot;</span>
                    <span class="n">dst</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwd</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">),</span> <span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">dst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_rec</span><span class="p">:</span>
                        <span class="c1"># free = &lt;disk space&gt; - 100MB</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span><span class="p">:</span>
                                <span class="n">fsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span><span class="o">.</span><span class="n">fsize</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fsize</span> <span class="o">=</span> <span class="n">getsize</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

                            <span class="n">free</span> <span class="o">=</span> <span class="n">disk_usage</span><span class="p">(</span><span class="n">D_DRIVE</span><span class="p">)</span><span class="o">.</span><span class="n">free</span> <span class="o">-</span> <span class="mi">100000000</span>
                            <span class="c1"># copy file and replace arguments (only when smaller than 150G)</span>
                            <span class="k">if</span> <span class="n">free</span> <span class="o">&gt;</span> <span class="n">fsize</span> <span class="ow">and</span> <span class="n">fsize</span> <span class="o">&lt;</span> <span class="mi">150000000000</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;copying &#39;</span><span class="si">%s</span><span class="s2">&#39; (</span><span class="si">%s</span><span class="s2">) -&gt; </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fsize</span><span class="p">)),</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">human_size</span><span class="p">(</span><span class="n">free</span><span class="p">))</span>
                                <span class="n">startm</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">CopyFileEx</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;copy to &#39;</span><span class="si">%s</span><span class="s2">&#39; done after </span><span class="si">%d</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">startm</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_local_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                                <span class="k">raise</span> <span class="n">HpcError</span><span class="p">(</span><span class="s2">&quot;not enough free space: </span><span class="si">{}</span><span class="s2">MB, rec: </span><span class="si">{}</span><span class="s2">MB&quot;</span>
                                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">free</span> <span class="o">//</span> <span class="mi">1000000</span><span class="p">,</span> <span class="n">fsize</span> <span class="o">//</span> <span class="mi">1000000</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;local copy rec failed: </span><span class="si">%s</span><span class="s2">!&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">ERR_INFRASTRUCTURE_FAILED_TO_COPY_DATA</span>

                    <span class="c1"># here we go if rec already on disk</span>
                    <span class="n">arglist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-lr</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
                    <span class="n">localrec</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">MSWIN</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_ip</span><span class="p">:</span>
            <span class="n">lropt</span> <span class="o">=</span> <span class="s1">&#39;-lr&#39;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arglist</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">lropt</span><span class="p">):</span>
                    <span class="n">arglist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lropt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_ip</span>
                    <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">command: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arglist</span><span class="p">),</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">cwd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">cwd: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># check mts.ini if it might have been manipulated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span><span class="p">:</span>
            <span class="n">ini</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">exe</span><span class="p">),</span> <span class="s2">&quot;mts.ini&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">ini</span><span class="p">)</span> <span class="ow">and</span> <span class="n">check_mts_ini</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">checkonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;mts.ini check failed, not having standard settings done properly!&quot;</span><span class="p">)</span>
                <span class="c1"># self._subexit(ERR_MTS_UNSPECIFIED_ERROR_FOUND)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">MSWIN</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># set the x flag on Linux</span>
                <span class="n">chmod</span><span class="p">(</span><span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stat</span><span class="p">(</span><span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">S_IEXEC</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># ignore silently</span>

        <span class="c1"># start the app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="n">BackgroundProcess</span><span class="p">(</span><span class="n">arglist</span><span class="p">,</span> <span class="n">cwd</span> <span class="k">if</span> <span class="n">cwd</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                                       <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">,</span> <span class="o">**</span><span class="n">pargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">pid</span>

        <span class="k">return</span> <span class="n">localrec</span>

    <span class="k">def</span> <span class="nf">_watch_dog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">localrec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0911,R0914</span>
        <span class="sd">&quot;&quot;&quot;wait until process ends&quot;&quot;&quot;</span>
        <span class="n">io_watch</span><span class="p">,</span> <span class="n">time_watch</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">localrec</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">iowatch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">timewatch</span>
        <span class="n">vargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">io_watch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">cpuwatch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">timewatch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">prnwatch</span><span class="p">]</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;HPC wdog:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">)</span>  <span class="c1"># , color=&quot;seagreen&quot;)</span>
        <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(((</span><span class="n">k</span> <span class="o">%</span> <span class="n">vargs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;%&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">else</span> <span class="n">k</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;I/O&quot;</span><span class="p">,</span> <span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="s2">&quot;Timeout (</span><span class="si">%s</span><span class="s2"> h)&quot;</span><span class="p">,</span> <span class="s2">&quot;prints&quot;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="p">[</span><span class="n">vargs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">cpuwatch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">timewatch</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">prnwatch</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">what</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;all watchdogs switched off, limiting your run to 6 hours!&quot;</span><span class="p">)</span>
            <span class="n">time_watch</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="n">inittime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wdog_init&#39;</span><span class="p">,</span> <span class="n">REPORT_WAIT_TIME_INITIAL</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span><span class="p">)]),</span> <span class="mf">1.2</span><span class="p">)</span>
        <span class="n">looptime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wdog_loop&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;wdog_loop&#39;</span><span class="p">]),</span> <span class="mf">1.2</span><span class="p">)</span>  <span class="c1"># 1.2 -&gt; prevent division by 0</span>
        <span class="n">loop_prn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wdog_prns&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;wdog_prns&#39;</span><span class="p">])</span>
        <span class="n">mts_exe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mts_exe&quot;</span><span class="p">,</span> <span class="s2">&quot;measapp.exe&quot;</span><span class="p">)</span>
        <span class="n">mem_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mem_max&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mem_max&#39;</span><span class="p">])</span>
        <span class="n">virt_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;virt_max&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;virt_max&#39;</span><span class="p">])</span>
        <span class="n">wdog_lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wdog_log</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wdog_log</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting to watch PID </span><span class="si">%d</span><span class="s2"> for </span><span class="si">%s</span><span class="s2"> and max mem </span><span class="si">%d</span><span class="s2">MB / max virt </span><span class="si">%d</span><span class="s2">MB&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">mem_max</span> <span class="o">//</span> <span class="mi">1000000</span><span class="p">,</span> <span class="n">virt_max</span> <span class="o">//</span> <span class="mi">1000000</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">time_watch</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">time_watch</span> <span class="o">=</span> <span class="n">MAX_TIME_WATCH</span>
        <span class="n">maxtime</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">time_watch</span><span class="p">,</span> <span class="n">MAX_TIME_WATCH</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>

        <span class="n">cpu_conf</span><span class="p">,</span> <span class="n">io_conf</span><span class="p">,</span> <span class="n">prn_conf</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span>
        <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cpu_usage</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">watch_time</span><span class="p">(</span><span class="n">until</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;wait until time expires&quot;&quot;&quot;</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">until</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="n">try_sleep</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">until</span> <span class="o">-</span> <span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">process_stats</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_io</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">IO_CNT</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cpu_time</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">PROC_TIME</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">datacoll</span> <span class="o">=</span> <span class="n">MonDataCollector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">proc</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_docker</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">MemoryError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="c1">#  try again if we might be able to...</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Memory error at watchdog, falling back to max time = </span><span class="si">%.1f</span><span class="s2">h!&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">48.</span><span class="p">,</span> <span class="n">time_watch</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ERR_APPLICATION_TIMEOUT</span> <span class="k">if</span> <span class="n">watch_time</span><span class="p">(</span><span class="n">maxtime</span><span class="p">)</span> <span class="k">else</span> <span class="n">ERR_OK</span>
        <span class="k">except</span> <span class="n">NoSuchProcess</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;seems, process exited already.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ERR_OK</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;other exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ERR_OK</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">watch_time</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">inittime</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;process exited (init).&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ERR_OK</span>

        <span class="k">for</span> <span class="n">lcnt</span> <span class="ow">in</span> <span class="n">count</span><span class="p">():</span>
            <span class="c1"># receive Input Data from the app_monitor</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">datacoll</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">if</span> <span class="n">fail_count</span> <span class="o">&gt;</span> <span class="n">pvs</span><span class="o">.</span><span class="n">FAIL_THRESHOLD</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;process stat request failed more than </span><span class="si">%d</span><span class="s2"> times in a row!!!&quot;</span><span class="p">,</span> <span class="n">pvs</span><span class="o">.</span><span class="n">FAIL_THRESHOLD</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">ERR_APPLICATION_UNSPECIFIED_ERROR_FOUND</span>
                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no data received (#</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fail_count</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># CPU load can be greater than 100% due to multicore usage</span>
                <span class="n">io_load</span><span class="p">,</span> <span class="n">cpu_load</span> <span class="o">=</span> <span class="n">data</span>
                <span class="c1"># save disk_io</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_io</span> <span class="o">=</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">io_load</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cpu_time</span> <span class="o">=</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">cpu_time</span>

                <span class="n">cpu_conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpu_conf</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pvs</span><span class="o">.</span><span class="n">FILTER_STRENGTH_CPU</span><span class="p">)</span> <span class="o">+</span> <span class="n">cpu_load</span> <span class="o">*</span> <span class="n">pvs</span><span class="o">.</span><span class="n">FILTER_STRENGTH_CPU</span><span class="p">)</span>
                <span class="n">io_conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">io_conf</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pvs</span><span class="o">.</span><span class="n">FILTER_STRENGTH_IO</span><span class="p">)</span> <span class="o">+</span>
                           <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">io_load</span> <span class="o">&lt;</span> <span class="n">pvs</span><span class="o">.</span><span class="n">FILTER_THRESHOLD_IO</span> <span class="k">else</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">pvs</span><span class="o">.</span><span class="n">FILTER_STRENGTH_IO</span><span class="p">)</span>
                <span class="n">prns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">prn_lines</span>
                <span class="n">prn_conf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">prn_conf</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pvs</span><span class="o">.</span><span class="n">FILTER_STRENGTH_PRN</span><span class="p">)</span> <span class="o">+</span> <span class="n">prns</span> <span class="o">*</span> <span class="mf">444.</span> <span class="o">*</span> <span class="n">pvs</span><span class="o">.</span><span class="n">FILTER_STRENGTH_PRN</span><span class="p">,</span> <span class="mf">100.</span><span class="p">)</span>
                <span class="n">cpu_usage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpu_load</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;wdog_log&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
                        <span class="n">dtnow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">EPOCH</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dtnow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
                    <span class="n">wdog_lst</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">io_load</span><span class="p">,</span> <span class="n">io_conf</span><span class="p">,</span> <span class="n">cpu_load</span><span class="p">,</span> <span class="n">cpu_conf</span><span class="p">,</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">mem_load</span><span class="p">,</span>
                                                           <span class="n">datacoll</span><span class="o">.</span><span class="n">virt_load</span><span class="p">,</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">net_io</span> <span class="o">//</span> <span class="mi">1000</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dtnow</span><span class="p">])</span>

                <span class="n">disk_stat</span> <span class="o">=</span> <span class="n">disk_usage</span><span class="p">(</span><span class="n">D_DRIVE</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">lcnt</span> <span class="o">%</span> <span class="n">loop_prn</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;IO: </span><span class="si">%.1f</span><span class="s2">kB/s (conf: </span><span class="si">%.1f</span><span class="s2">), CPU: </span><span class="si">%.1f%%</span><span class="s2"> (conf: </span><span class="si">%.1f</span><span class="s2">), &quot;</span>
                                <span class="s2">&quot;MEM: </span><span class="si">%s</span><span class="s2"> / VIRT: </span><span class="si">%s</span><span class="s2">, tot IO: </span><span class="si">%d</span><span class="s2">kB/s, prints: </span><span class="si">%d</span><span class="s2"> (conf: </span><span class="si">%.1f</span><span class="s2">), temp free: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">io_load</span><span class="p">,</span> <span class="n">io_conf</span><span class="p">,</span> <span class="n">cpu_load</span><span class="p">,</span> <span class="n">cpu_conf</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">datacoll</span><span class="o">.</span><span class="n">mem_load</span><span class="p">),</span>
                                <span class="n">human_size</span><span class="p">(</span><span class="n">datacoll</span><span class="o">.</span><span class="n">virt_load</span><span class="p">),</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">net_io</span> <span class="o">//</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">prns</span><span class="p">,</span> <span class="n">prn_conf</span><span class="p">,</span>
                                <span class="n">human_size</span><span class="p">(</span><span class="n">disk_stat</span><span class="o">.</span><span class="n">free</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">))</span>

                <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">disk_stat</span><span class="o">.</span><span class="n">percent</span> <span class="o">&gt;</span> <span class="mf">90.</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;reaching 90</span><span class="si">%%</span><span class="s2"> fill state on </span><span class="si">%s</span><span class="s2">: </span><span class="si">%.1f%%</span><span class="s2">, cannot continue!&quot;</span><span class="p">,</span> <span class="n">D_DRIVE</span><span class="p">,</span> <span class="n">disk_stat</span><span class="o">.</span><span class="n">percent</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_HPC_LOW_DISK_SPACE</span>
                <span class="k">elif</span> <span class="n">disk_stat</span><span class="o">.</span><span class="n">percent</span> <span class="o">&gt;</span> <span class="mf">80.</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;reaching more than 80</span><span class="si">%%</span><span class="s2"> fill state on </span><span class="si">%s</span><span class="s2">: </span><span class="si">%.1f%%</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">D_DRIVE</span><span class="p">,</span> <span class="n">disk_stat</span><span class="o">.</span><span class="n">percent</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">io_watch</span> <span class="ow">and</span> <span class="n">io_conf</span> <span class="o">&lt;</span> <span class="n">pvs</span><span class="o">.</span><span class="n">IO_CONFIDENCE_THRESHOLD</span><span class="p">:</span>  <span class="c1"># check i/o threshold</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Process I/O traffic is too low!!!&quot;</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_APPLICATION_IO_IDLE</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">cpuwatch</span> <span class="ow">and</span> <span class="n">cpu_conf</span> <span class="o">&lt;</span> <span class="n">pvs</span><span class="o">.</span><span class="n">CPU_CONFIDENCE_THRESHOLD</span><span class="p">:</span>  <span class="c1"># check cpu threshold</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Process is idle (no CPU)!!!&quot;</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_APPLICATION_CPU_IDLE</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">prnwatch</span> <span class="ow">and</span> <span class="n">prn_conf</span> <span class="o">&lt;</span> <span class="n">pvs</span><span class="o">.</span><span class="n">PRN_CONFIDENCE_THRESHOLD</span><span class="p">:</span>  <span class="c1"># check prn threshold</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Process has no print outs!!!&quot;</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_APPLICATION_PRN_IDLE</span>

                <span class="k">elif</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">mem_load</span> <span class="o">&gt;</span> <span class="n">mem_max</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">proc_name</span> <span class="o">==</span> <span class="n">mts_exe</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;MTS uses more memory than allowed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">datacoll</span><span class="o">.</span><span class="n">mem_load</span><span class="p">))</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_MTS_MEM_LEAK_FOUND</span>
                    <span class="k">elif</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">mem_load</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mem_max</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> uses more memory than allowed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                     <span class="n">datacoll</span><span class="o">.</span><span class="n">proc_name</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">datacoll</span><span class="o">.</span><span class="n">mem_load</span><span class="p">))</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_APPLICATION_HIGH_MEM</span>

                <span class="k">if</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">virt_load</span> <span class="o">&gt;</span> <span class="n">virt_max</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> uses more virtual memory than allowed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                 <span class="n">datacoll</span><span class="o">.</span><span class="n">proc_name</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">datacoll</span><span class="o">.</span><span class="n">virt_load</span><span class="p">))</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_APPLICATION_HIGH_MEM</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">fatal_cnt</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;fatal message appeared&quot;</span><span class="p">)</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_APPLICATION_FATAL</span>

                <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>  <span class="c1"># should we print?</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;issuing errorcode: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">maxtime</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;application timed out after </span><span class="si">{:.2f}</span><span class="s2">h, ErrorCode: </span><span class="si">{!s}</span><span class="s2">&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">time_watch</span><span class="p">,</span> <span class="n">MAX_TIME_WATCH</span><span class="p">),</span> <span class="n">ERR_APPLICATION_TIMEOUT</span><span class="p">))</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_APPLICATION_TIMEOUT</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">watch_time</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">looptime</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;process exited (loop).&quot;</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_OK</span>
                <span class="k">break</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;system net IO: </span><span class="si">%d</span><span class="s2">B/s, system CPU: </span><span class="si">%.1f%%</span><span class="s2">, system disk I/O: </span><span class="si">%d</span><span class="s2">B&quot;</span><span class="p">,</span>
                    <span class="n">datacoll</span><span class="o">.</span><span class="n">net_io</span><span class="p">,</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">tot_cpu</span><span class="p">,</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">tot_disk</span><span class="p">)</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">datacoll</span><span class="o">.</span><span class="n">io_tm</span> <span class="o">-</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">proc_start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;proc runtime: </span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%d</span><span class="s2">s (</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">:</span><span class="si">%02d</span><span class="s2">), proc I/O: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">proc_start</span><span class="p">,</span> <span class="n">datacoll</span><span class="o">.</span><span class="n">io_tm</span><span class="p">,</span>
                    <span class="n">runtime</span><span class="p">,</span> <span class="n">runtime</span> <span class="o">//</span> <span class="mi">3600</span><span class="p">,</span> <span class="n">runtime</span> <span class="o">//</span> <span class="mi">60</span> <span class="o">%</span> <span class="mi">60</span><span class="p">,</span> <span class="n">runtime</span> <span class="o">%</span> <span class="mi">60</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">datacoll</span><span class="o">.</span><span class="n">io_load</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cpu_usage</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CPU average: </span><span class="si">%.1f%%</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cpu_usage</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpu_usage</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CPU average: n/a&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_check_for_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arglist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check app watcher and the process, if an error happened or not.</span>

<span class="sd">        :param list arglist: argument list (application)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_ret</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ERR_APPLICATION_CPU_IDLE</span><span class="p">,</span> <span class="n">ERR_APPLICATION_IO_IDLE</span><span class="p">,</span> <span class="n">ERR_APPLICATION_TIMEOUT</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recording</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;recording &#39;</span><span class="si">%s</span><span class="s2">&#39; was </span><span class="si">%d</span><span class="s2"> bytes big&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">recording</span><span class="p">,</span> <span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recording</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_ret</span> <span class="o">!=</span> <span class="n">ERR_OK</span><span class="p">:</span>  <span class="c1"># set subtask exitcode for all app watcher errors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_ret</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_handler</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;error code after execution: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>

        <span class="n">exmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">USR_EXMAP</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">exmap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">USR_EXMAP</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">procex</span> <span class="o">=</span> <span class="n">exmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">procex</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;remapping exitcode to </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">procex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">=</span> <span class="n">procex</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span><span class="p">:</span>  <span class="c1"># check exit code for measapp.exe</span>
            <span class="n">sbase</span><span class="p">,</span> <span class="n">cbase</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">arglist</span><span class="p">:</span>  <span class="c1"># pylint: disable=R1702</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-pc&#39;</span><span class="p">):</span>
                    <span class="n">cbase</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cbase</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;MTS is missing config base folder option!&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_ret</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ERR_APPLICATION_CPU_IDLE</span><span class="p">,</span> <span class="n">ERR_APPLICATION_IO_IDLE</span><span class="p">,</span> <span class="n">ERR_APPLICATION_TIMEOUT</span><span class="p">):</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">minver</span> <span class="ow">in</span> <span class="n">FILE_CHECKS</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">sys</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sbase</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">cfg</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cbase</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                        <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">version</span> <span class="o">=</span> <span class="n">file_version</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="n">minver</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is too old: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">version</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">})</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_MTS_OLD_DLL_DETECTED</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is alright: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">version</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">})</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&#39;s version cannot be distinguished!&quot;</span><span class="p">,</span> <span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;not found: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">missing</span><span class="p">)),</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">})</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;measapp.exe version is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_version</span><span class="p">(</span><span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;unable to extract version from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">MTS_LOOKUP_EXITCODE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">,</span> <span class="n">ERR_MTS_UNSPECIFIED_ERROR_FOUND</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mtscheck&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mts_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">rectms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">recdiff</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pass_ecode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_docker</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker_err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;docker originally returned </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_docker_err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_docker_err</span> <span class="o">=</span> <span class="n">ERR_OK</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="mi">220</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_py</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_PYTHON_UNSPECIFIED_ERROR_FOUND</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_APPLICATION_UNSPECIFIED_ERROR_FOUND</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">running</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mts_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excode</span><span class="p">,</span> <span class="n">rectms</span><span class="p">,</span> <span class="n">recdiff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;check MTS errors&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;mtscheck&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;MTS check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;checking MTS logs.&quot;</span><span class="p">)</span>
                <span class="n">errors</span><span class="p">,</span> <span class="n">ecnt</span><span class="p">,</span> <span class="n">logs</span> <span class="o">=</span> <span class="n">mts_log_check</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskfolder</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">),</span> <span class="n">exitcodes</span><span class="o">=</span><span class="n">excode</span><span class="p">,</span>
                                                   <span class="n">log_corrupts</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
                                                   <span class="n">level</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">errorlevel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">errorlevel</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_envhandler</span><span class="o">.</span><span class="n">errors</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">ecnt</span><span class="p">)</span>
                <span class="n">estr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;crashes&quot;</span><span class="p">,</span> <span class="s2">&quot;exceptions&quot;</span><span class="p">,</span> <span class="s2">&quot;alerts&quot;</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ecnt</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">logs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">estr</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;there are MTS log issues: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">estr</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no issues found from logs.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;log checker exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
                <span class="n">excode</span><span class="p">(</span><span class="n">ERR_INFRASTRUCTURE_UNSPECIFIC_ERROR_FOUND</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;error code after MTS log check: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">excode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mts_check_cnt</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">BSIG_CHK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">bsig_check</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">BSIG_CHK</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;checking bsig&#39;s/csv&#39;s...&quot;</span><span class="p">)</span>
            <span class="n">excode</span><span class="p">(</span><span class="n">bsig_check</span><span class="p">(</span><span class="n">bsigs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datafolder</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;bsig check:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">),</span> <span class="n">exit_prio</span><span class="o">=</span><span class="n">excode</span><span class="p">,</span>
                              <span class="n">rectms</span><span class="o">=</span><span class="n">rectms</span><span class="p">,</span> <span class="n">recdiff</span><span class="o">=</span><span class="n">recdiff</span><span class="p">,</span> <span class="n">bsig_ext</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;bsig_ext&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;.bsig&quot;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_change_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;look up IP address of recording&#39;s server which in turn does a round robin of the IP&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span>
            <span class="n">orip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_ip</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">splt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">splt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolve_ip</span><span class="p">(</span><span class="n">splt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rec_ip</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_ip</span> <span class="o">!=</span> <span class="n">orip</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">try_sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">iex</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;unable to find host&#39;s IP addr (</span><span class="si">%s</span><span class="s2">)!&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">iex</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_start_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arglist</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0914</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        start real application and watch it.</span>

<span class="sd">        :param list arglist: list of parameters</span>
<span class="sd">        :param str cwd:      current working dir</span>
<span class="sd">        :param dict kwargs:  pass through, for _start_process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># recording available -&gt; do the check</span>
            <span class="k">for</span> <span class="n">retr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>  <span class="c1"># check if file exists</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span><span class="p">:</span>
                        <span class="n">fsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span><span class="o">.</span><span class="n">fsize</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;recording is valid and has size=</span><span class="si">%d</span><span class="s2">B (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fsize</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">fsize</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_change_ip</span><span class="p">()</span>
                        <span class="c1"># check network throughput by reading 10 seconds along recording</span>
                        <span class="n">recfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_ip</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_ip</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;checking </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)...&quot;</span><span class="p">,</span> <span class="n">recfn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span><span class="p">)</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">recfn</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                            <span class="n">dur</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">time</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65536</span>
                            <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">dur</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">10.</span><span class="p">:</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span>  <span class="c1"># read about 8k</span>
                                <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                                    <span class="k">break</span>
                            <span class="n">dur</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">dur</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">*</span> <span class="n">sz</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">throughput</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">/</span> <span class="n">dur</span>
                            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                                <span class="n">throughput</span> <span class="o">=</span> <span class="n">inf</span>

                        <span class="k">if</span> <span class="n">throughput</span> <span class="o">&lt;</span> <span class="n">pvs</span><span class="o">.</span><span class="n">MIN_NET_THROUGHPUT</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                            <span class="n">log</span><span class="p">,</span> <span class="n">madd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">,</span> <span class="s2">&quot;=&gt; below minimum of </span><span class="si">{}</span><span class="s2">MB/s!&quot;</span>\
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pvs</span><span class="o">.</span><span class="n">MIN_NET_THROUGHPUT</span> <span class="o">//</span> <span class="mi">1000000</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">,</span> <span class="n">madd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="s2">&quot;=&gt; good&quot;</span> <span class="k">if</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="mi">3000000</span> <span class="k">else</span> <span class="s2">&quot;=&gt; unsure&quot;</span>

                        <span class="n">fsize</span> <span class="o">=</span> <span class="n">getsize</span><span class="p">(</span><span class="n">recfn</span><span class="p">)</span>
                        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;size=</span><span class="si">%d</span><span class="s2">B (</span><span class="si">%s</span><span class="s2">), read </span><span class="si">%d</span><span class="s2">B during </span><span class="si">%.1f</span><span class="s2">s = </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fsize</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">fsize</span><span class="p">),</span>
                            <span class="n">sz</span><span class="p">,</span> <span class="n">dur</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">throughput</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;bps&quot;</span><span class="p">),</span> <span class="n">madd</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">free</span> <span class="o">&lt;</span> <span class="n">pvs</span><span class="o">.</span><span class="n">MIN_MEM_FREE</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;free virtual memory is lower than allowed minimum </span><span class="si">%s</span><span class="s2"> &lt; </span><span class="si">%s</span><span class="s2">!&quot;</span><span class="p">,</span>
                                             <span class="n">human_size</span><span class="p">(</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">free</span><span class="p">),</span> <span class="n">human_size</span><span class="p">(</span><span class="n">pvs</span><span class="o">.</span><span class="n">MIN_MEM_FREE</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_APPLICATION_LOW_MEM</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cpu_percent</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pvs</span><span class="o">.</span><span class="n">MAX_CPU_USAGE</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;cpu utilization exceeds maximum allowed of </span><span class="si">%.0f</span><span class="s2">!&quot;</span><span class="p">,</span> <span class="n">pvs</span><span class="o">.</span><span class="n">MAX_CPU_USAGE</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_APPLICATION_LOW_CPU</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">retr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;trying again as of error &#39;</span><span class="si">%s</span><span class="s2">&#39;...&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_change_ip</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;measurement not available: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;OSError:: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_INFRASTRUCTURE_RECORDING_UNAVAILABLE</span><span class="p">)</span>
                        <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span> <span class="ow">and</span> <span class="n">MSWIN</span> <span class="ow">and</span> <span class="n">GetFileAttributesW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recording</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FILE_ATTRIBUTE_OFFLINE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;measurement archived: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_INFRASTRUCTURE_RECORDING_ARCHIVED</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">recmap</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">measid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;measurement not registered inside DB!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;we&#39;re not testing a measurement, no availability checks performed.&quot;</span><span class="p">)</span>

        <span class="c1"># start wrapper apps</span>
        <span class="k">with</span> <span class="n">WrapProc</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;wrapexe&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">wraproc</span><span class="p">:</span>
            <span class="n">main_wnd</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># workaround for MTS main window creation / reading recording problem</span>
            <span class="k">while</span> <span class="n">main_wnd</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># pylint: disable=R1702</span>
                <span class="k">if</span> <span class="n">main_wnd</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;re-starting MTS again...&quot;</span><span class="p">)</span>

                <span class="n">localrec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_process</span><span class="p">(</span><span class="n">arglist</span><span class="p">,</span> <span class="n">cwd</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wraproc</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span><span class="p">:</span>
                    <span class="c1"># wait until process ends</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_ret</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">_watch_dog</span><span class="p">(</span><span class="n">localrec</span><span class="p">,</span>
                                        <span class="n">wdog_ltime</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;wdog_init&quot;</span><span class="p">,</span> <span class="n">REPORT_WAIT_TIME_CYCLE</span><span class="p">),</span>
                                        <span class="n">wdog_loop</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;wdog_loop&quot;</span><span class="p">,</span> <span class="n">REPORT_WAIT_TIME_CYCLE</span><span class="p">),</span>
                                        <span class="n">wdog_prns</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;wdog_prns&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                        <span class="n">mem_max</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;mem_max&quot;</span><span class="p">,</span> <span class="n">pvs</span><span class="o">.</span><span class="n">MIN_MEM_FREE</span><span class="p">),</span>
                                        <span class="n">virt_max</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;virt_max&quot;</span><span class="p">,</span> <span class="n">pvs</span><span class="o">.</span><span class="n">MIN_VIRT_FREE</span><span class="p">))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                        <span class="c1"># if not self._is_mts:</span>
                        <span class="c1">#     self._logger.info(&quot;application finished (%d)&quot;, self._proc.exitcode)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;measapp.exe finished (</span><span class="si">{!s}</span><span class="s2">) -&gt; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span> <span class="ow">in</span> <span class="n">MTS_LOOKUP_EXITCODE</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">MTS_LOOKUP_EXITMSG</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">emsg</span> <span class="o">=</span> <span class="n">WinError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span><span class="o">.</span><span class="n">strerror</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">emsg</span> <span class="o">=</span> <span class="s2">&quot;unknown error happened&quot;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> ?</span><span class="si">%s</span><span class="s2">?&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">emsg</span><span class="p">)</span>

                    <span class="n">main_wnd</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,)</span> <span class="k">else</span> <span class="mi">3</span>
                    <span class="k">if</span> <span class="n">main_wnd</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_change_ip</span><span class="p">()</span>
                        <span class="k">continue</span>  <span class="c1"># try again to start the MTS</span>

                    <span class="c1"># check for an error code from process</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_error</span><span class="p">(</span><span class="n">arglist</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">localrec</span> <span class="o">==</span> <span class="n">ERR_INFRASTRUCTURE_FAILED_TO_COPY_DATA</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_INFRASTRUCTURE_FAILED_TO_COPY_DATA</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">(</span><span class="n">ERR_HPC_APPLICATION_NOT_FOUND</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">main_wnd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1"># set environ var for original exitcode</span>
            <span class="n">environ</span><span class="p">[</span><span class="s2">&quot;exitcode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span>

<div class="viewcode-block" id="AppStarter.execute"><a class="viewcode-back" href="../../hpc.html#hpc.starter.AppStarter.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0914</span>
        <span class="sd">&quot;&quot;&quot;start the application based on database input.&quot;&quot;&quot;</span>
        <span class="n">taskstarttm</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting on node </span><span class="si">%s</span><span class="s2"> inside </span><span class="si">%s</span><span class="s2"> as user </span><span class="si">%s</span><span class="s2"> with HPC V </span><span class="si">%s</span><span class="s2"> with Python </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                          <span class="n">gethostname</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cwd</span><span class="p">,</span> <span class="n">getuser</span><span class="p">(),</span> <span class="n">__version__</span><span class="p">,</span>
                          <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">python_version_tuple</span><span class="p">()),</span> <span class="n">architecture</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df_start</span> <span class="o">=</span> <span class="n">disk_usage</span><span class="p">(</span><span class="n">D_DRIVE</span><span class="p">)</span><span class="o">.</span><span class="n">free</span>
        <span class="n">log</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span> <span class="k">if</span> <span class="n">df_start</span> <span class="o">&gt;</span> <span class="n">pvs</span><span class="o">.</span><span class="n">D_FREE_THRESHOLD</span> <span class="k">else</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;space available on </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">D_DRIVE</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">df_start</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">)))</span>
        <span class="c1"># self._verbose = kwargs.get(&quot;verblevel&quot;, 0)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;taskid&quot;</span><span class="p">,</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CCP_TASKID&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TASKNAME&quot;</span><span class="p">,</span> <span class="s2">&quot;T</span><span class="si">{:0&gt;5}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>

        <span class="c1"># read job stuff from db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">networkpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">server_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">head</span> <span class="k">if</span> <span class="n">head_name</span><span class="p">()</span> <span class="k">else</span> <span class="n">OTHER</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_envhandler</span> <span class="o">=</span> <span class="n">EnvData</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbase</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mail_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">NOTIFY_START</span><span class="p">),</span> <span class="s2">&quot;Running&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TaskID discrepancy: task </span><span class="si">%s</span><span class="s2"> misconfigured!&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">ERR_HPC_PID_INVALID</span><span class="p">)</span>

        <span class="c1"># create standard folders for the task</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_std_items</span><span class="p">(</span><span class="s2">&quot;TaskStart&quot;</span><span class="p">):</span>
            <span class="c1"># set env vars for all subprocess</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;JobID&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;JobName&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">,),</span>
                         <span class="p">(</span><span class="s2">&quot;TaskID&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;TaskName&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,),</span>
                         <span class="p">(</span><span class="s2">&quot;HPCTaskDataFolder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datafolder</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;HPCTaskTmpFolder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempfolder</span><span class="p">,),):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="c1"># set ctrl+break handler</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">signal</span><span class="p">(</span><span class="n">SIG_END</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_handler</span><span class="p">)</span>
                <span class="n">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_handler</span><span class="p">)</span>
                <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_handler</span><span class="p">)</span>
                <span class="n">signal</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_handler</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">val</span><span class="p">:</span>
                <span class="c1"># we&#39;re already in a thread...</span>
                <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">message</span> <span class="o">!=</span> <span class="s2">&quot;signal only works in main thread&quot;</span><span class="p">:</span>  <span class="c1"># pylint: disable=E1101</span>
                    <span class="k">raise</span>
            <span class="n">skip</span><span class="p">,</span> <span class="n">skip_prn</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="kc">False</span>

            <span class="k">with</span> <span class="n">WrapProc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">WRAP_EXE</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">wraproc</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">wraproc</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>  <span class="c1"># no chance to do it inside the class itself breaking inside this context</span>
                    <span class="k">raise</span> <span class="n">HpcError</span><span class="p">(</span><span class="n">wraproc</span><span class="o">.</span><span class="n">failed</span><span class="p">,</span> <span class="n">ERR_APPLICATION_WRAPPER</span><span class="p">)</span>

                <span class="c1"># do the complete processing of one SubTask</span>
                <span class="k">for</span> <span class="n">subidx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;we have a dummy task (aka NOP), continuing here.&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;we&#39;re requested to quit, no further sub-tasks will be executed!&quot;</span><span class="p">)</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="p">,</span> <span class="s2">&quot;eoe&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;Failed&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;due to eoe=True, no further sub-tasks will be executed!&quot;</span><span class="p">)</span>
                        <span class="k">break</span>

                    <span class="n">which</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;Failed&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">skip</span><span class="p">[</span><span class="n">which</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_prn</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;skipping next </span><span class="si">%d</span><span class="s2"> subtask(s) as of state </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                                              <span class="n">skip</span><span class="p">[</span><span class="n">which</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                            <span class="n">skip_prn</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">skip</span><span class="p">[</span><span class="n">which</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">skip</span><span class="p">[</span><span class="n">which</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;skipping the rest of subtasks as of state </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                        <span class="k">break</span>

                    <span class="n">skipon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skipon&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">error</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">skipon</span> <span class="o">+</span> <span class="n">skipon</span><span class="p">)</span>
                            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">lasterror</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">skipon</span> <span class="o">+</span> <span class="n">skipon</span><span class="p">)</span>
                            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">skipon</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stepping over subtask </span><span class="si">%d</span><span class="s2"> due to exitcode </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">subidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">EXIT_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))</span>
                        <span class="c1"># self._subexit = ExitCodes(self._exitcode, init_code=ERR_PSEUDO_SKIPON)</span>
                        <span class="k">continue</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s2">&quot;SUBTASKID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">subidx</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">starttm</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting subtask </span><span class="si">%d</span><span class="s2"> (id </span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">subidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">subid</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>

                    <span class="c1"># do the extra-logging</span>
                    <span class="n">xlogs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xlog&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="n">xlogs</span><span class="p">:</span>
                        <span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;usr xlog:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">xlogs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">ent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;error&quot;</span><span class="p">)(</span><span class="n">ent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span>

                    <span class="c1"># set needed environment vars</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">env</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">env</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># fallback due to transition errors</span>
                        <span class="n">env</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">envdata</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">env</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">replace_env_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="mi">1</span><span class="p">]))):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

                    <span class="c1"># replace all variables in CMDList</span>
                    <span class="n">replace_env_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">replace_env_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">workdir</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;replace_path&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                        <span class="n">arglist</span> <span class="o">=</span> <span class="n">replace_server_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">networkpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">StringTypes</span><span class="p">):</span>
                        <span class="n">arglist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">command</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">arglist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">command</span>

                    <span class="n">mtc</span> <span class="o">=</span> <span class="n">match</span><span class="p">(</span><span class="n">AZR_BLOB_STX</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">recording</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">mtc</span> <span class="ow">and</span> <span class="n">MSWIN</span><span class="p">:</span>
                        <span class="n">cstr</span> <span class="o">=</span> <span class="n">AZR_CONN_STR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mtc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;epp&quot;</span><span class="p">),</span> <span class="n">mtc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;account&quot;</span><span class="p">),</span>
                                                   <span class="n">AZR_ACC_KEYS</span><span class="p">[</span><span class="n">mtc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;account&quot;</span><span class="p">)],</span> <span class="n">mtc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;suffix&quot;</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span> <span class="o">=</span> <span class="n">CloudBlob</span><span class="p">(</span><span class="n">cstr</span><span class="p">,</span> <span class="n">mtc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;container&quot;</span><span class="p">),</span> <span class="n">mtc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;blob&quot;</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">HpcError</span><span class="p">(</span><span class="s2">&quot;Azure STK not properly installed!&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cloud_rec</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_recording</span> <span class="o">=</span> <span class="n">replace_server_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">recording</span><span class="p">)</span> <span class="k">if</span> <span class="n">MSWIN</span> \
                        <span class="k">else</span> <span class="n">win2linux</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">recording</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rec_ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cpu_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>

                    <span class="c1"># do the real application call and re-prioritise</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_wdog_log</span><span class="p">[</span><span class="n">subidx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_start_app</span><span class="p">(</span><span class="n">arglist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>
                                    <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[[</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;outchk&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                                                                               <span class="p">[</span><span class="s2">&quot;wrapexe&quot;</span><span class="p">,</span> <span class="p">[]]]})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_all_cpu_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cpu_time</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">)</span>
                    <span class="n">logmsg</span> <span class="o">=</span> <span class="s2">&quot;error code after subtask: </span><span class="si">{!s}</span><span class="s2"> --&gt; tasks exitcode: </span><span class="si">{}</span><span class="s2">&quot;</span>\
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">error</span> <span class="o">==</span> <span class="n">ERR_OK</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">)(</span><span class="n">logmsg</span><span class="p">)</span>
                    <span class="n">stoptm</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_envhandler</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;subtaskid&quot;</span><span class="p">:</span> <span class="n">subidx</span><span class="p">,</span> <span class="s2">&quot;starttime&quot;</span><span class="p">:</span> <span class="n">starttm</span><span class="p">,</span> <span class="s2">&quot;stoptime&quot;</span><span class="p">:</span> <span class="n">stoptm</span><span class="p">,</span>
                                             <span class="s2">&quot;exitcode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arglist</span><span class="p">)[:</span><span class="mi">2000</span><span class="p">],</span>
                                             <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_taskpid</span><span class="p">,</span> <span class="s2">&quot;measpath&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">recording</span><span class="p">,</span>
                                             <span class="s2">&quot;disk_io&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_watch_io</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">app</span><span class="p">,</span>
                                             <span class="s2">&quot;measid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">measid</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">recmap</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                             <span class="s2">&quot;cfg&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">simcfg</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cpu_time</span><span class="p">})</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s2">&quot;SUBTASK</span><span class="si">{}</span><span class="s2">_TIMING&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subidx</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span>\
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mktime</span><span class="p">(</span><span class="n">starttm</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())),</span> <span class="nb">int</span><span class="p">(</span><span class="n">mktime</span><span class="p">(</span><span class="n">stoptm</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s2">&quot;SUBTASK</span><span class="si">{}</span><span class="s2">_ERROR&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subidx</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s2">&quot;SUBTASK</span><span class="si">{}</span><span class="s2">_STATE&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subidx</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">state</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s2">&quot;TASK_ERROR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s2">&quot;TASK_STATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">state</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mts</span><span class="p">:</span>
                        <span class="n">rectms</span><span class="p">,</span> <span class="n">recdiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">rectms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask</span><span class="o">.</span><span class="n">recdiff</span>

            <span class="k">if</span> <span class="n">wraproc</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">ERR_APPLICATION_WRAPPER</span><span class="p">)</span>

            <span class="n">cncl_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">CNCL_CMD</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span> <span class="ow">and</span> <span class="n">cncl_cmd</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cncl_cmd</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">cncl_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cncl_cmd</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cncl_cmd</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">replace_env_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;executing specified cancel command: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
                    <span class="n">pcncl</span> <span class="o">=</span> <span class="n">BackgroundProcess</span><span class="p">([</span><span class="n">cmd</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;cancel cmd:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streams</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                              <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>
                    <span class="n">tmr</span> <span class="o">=</span> <span class="n">LogTimer</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">pcncl</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                    <span class="n">tmr</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">pcncl</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;all subtasks finished.&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>

            <span class="c1"># remove local recordings</span>
            <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_rec</span><span class="p">:</span>
                <span class="n">unlink</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mts_cnt</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mts_check_cnt</span><span class="p">:</span>
                    <span class="c1"># let&#39;s take the times from last task</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mts_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">,</span> <span class="n">rectms</span><span class="p">,</span> <span class="n">recdiff</span><span class="p">)</span>

                <span class="c1"># copy and delete data files</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_copy_delete_data</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_create_std_items</span><span class="p">(</span><span class="s2">&quot;TaskStop&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">112</span><span class="p">)</span>
            <span class="n">df_end</span> <span class="o">=</span> <span class="n">disk_usage</span><span class="p">(</span><span class="n">D_DRIVE</span><span class="p">)</span><span class="o">.</span><span class="n">free</span>
            <span class="n">log</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span> <span class="k">if</span> <span class="n">df_end</span> <span class="o">&gt;</span> <span class="n">pvs</span><span class="o">.</span><span class="n">D_FREE_THRESHOLD</span> <span class="k">else</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;space available on </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, diff: </span><span class="si">{:.2f}</span><span class="s2">%&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">D_DRIVE</span><span class="p">,</span> <span class="n">human_size</span><span class="p">(</span><span class="n">df_end</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df_end</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">/</span> <span class="n">df_start</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mail_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">NOTIFY_STOP</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;total subtask runtime: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">taskstarttm</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exitcode history:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">prio</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exitcode </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) with prio </span><span class="si">%d</span><span class="s2"> reported @ </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                  <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">EXIT_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">prio</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">UTC</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;=&gt; HPC task ends with exit code </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">): </span><span class="si">%s</span><span class="s1">: state=</span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">EXIT_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exitcode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: exit code</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span>

    <span class="nd">@exitcode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">exitcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:param int value: new exitcode value&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exitmessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: exit message</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">desc</span>

    <span class="k">def</span> <span class="nf">_write_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;write stream to file&quot;&quot;&quot;</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networkpath</span><span class="p">,</span> <span class="s2">&quot;2_Output&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>  <span class="c1"># seems, output dir doesn&#39;t exist sometimes???</span>
                    <span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">ecnt</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;data </span><span class="si">%s</span><span class="s2"> is no longer available at storage location&quot;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">99999</span><span class="p">):</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;stdout_</span><span class="si">%05d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">ecnt</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="n">try_sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;, giving up&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># pylint: disable=W1201</span>
                                <span class="k">return</span> <span class="kc">None</span>
                            <span class="n">ecnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outfile</span> <span class="o">=</span> <span class="n">TemporaryFile</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">streamer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamer</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.*)(&lt;span style=</span><span class="se">\&quot;</span><span class="s2">background-color: \w+</span><span class="se">\&quot;</span><span class="s2">&gt;)(.*)(&lt;/span&gt;)(.*)$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1\3\5&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>

                <span class="c1"># copyfileobj(self.streamer, outfile)</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_ex</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unable to write stdoutfile to </span><span class="si">{}</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outdir</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">try_sleep</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outfile</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">out_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: output stream</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">streamer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamer</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>

<div class="viewcode-block" id="AppStarter.finalize"><a class="viewcode-back" href="../../hpc.html#hpc.starter.AppStarter.finalize">[docs]</a>    <span class="nd">@timeit</span>
    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;finalize by saving rest of data to DB&quot;&quot;&quot;</span>
        <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobdb</span><span class="o">.</span><span class="n">head</span> <span class="k">if</span> <span class="n">head_name</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_node</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">portal</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">HPC_STORAGE_MAP</span><span class="p">[</span><span class="n">head</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">_taskdur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_envhandler</span><span class="o">.</span><span class="n">end_task</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">used_db</span><span class="p">,</span> <span class="n">requ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_envhandler</span><span class="o">.</span><span class="n">update_task</span><span class="p">(</span><span class="n">noprn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exitcode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                                                         <span class="n">headnode</span><span class="o">=</span><span class="n">head</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span>
                                                         <span class="n">stdout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">streamer</span><span class="p">,</span> <span class="n">errmons</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_errmons</span><span class="p">,</span>
                                                         <span class="n">ehist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">history</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subexit</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
                                                         <span class="n">cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_cpu_time</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                                                         <span class="n">tname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span> <span class="n">wdog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_wdog_log</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">head_name</span><span class="p">():</span>  <span class="c1"># when running locally (via JobSim)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">used_db</span> <span class="o">==</span> <span class="n">EnvData</span><span class="o">.</span><span class="n">NO_DB</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">we&#39;ve failed to connect to DB!&quot;</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_stream</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># doesn&#39;t work any longer as users do not have the right to overwrite.....</span>
                <span class="c1"># print(&quot;[{{000214A0-0000-0000-C000-000000000046}}]\r\nProp3=19,2\r\n[InternetShortcut]\r\n&quot;</span>
                <span class="c1">#       &quot;IDList=\r\nURL=http://hpcportal.conti.de/php/HPC/task/{}/{}/{}&quot;</span>
                <span class="c1">#       .format(self.head_node, self.jobid, self.task_id), file=sys.stderr)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">you&#39;ll find your task output here:&quot;</span><span class="p">)</span>
                <span class="c1"># requ = int(environ[&quot;CCP_RETRY_COUNT&quot;])</span>
                <span class="k">if</span> <span class="n">requ</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/task/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">portal</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">requ</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/task/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">portal</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_id</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="p">(</span><span class="n">ERR_HPC_DATABASE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database Exception happened: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HPC task&#39;s exitcode adjusted as being unable to write to DB: </span><span class="si">%d</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitcode</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_stream</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">you&#39;ll find your task output here:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">linux2win</span><span class="p">(</span><span class="n">out</span><span class="p">)))</span>
            <span class="c1"># with open(join(HPC_STORAGE_MAP[self.head_node][1], &quot;hpc&quot;, &quot;HPC_backup&quot;,</span>
            <span class="c1">#                &quot;{}_{}_{}&quot;.format(self.head_node, self.jobid, self.task_id)), &quot;w&quot;) as lnkfp:</span>
            <span class="c1">#     lnkfp.write(join(self.networkpath, &#39;2_Output&#39;, self.taskname, &quot;hpc.sqlite&quot;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div></div>


<span class="c1"># - functions ----------------------------------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_multi_start</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    start a task</span>

<span class="sd">    :param list args: scheduler name, task id and Q are given</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sched</span><span class="p">,</span> <span class="n">taskid</span><span class="p">,</span> <span class="n">snk</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">starter</span> <span class="o">=</span> <span class="n">AppStarter</span><span class="p">(</span><span class="n">sched</span><span class="o">=</span><span class="n">sched</span><span class="p">)</span>
        <span class="n">starter</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="c1"># catches all non system exiting exceptions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;no such task:&quot;</span><span class="p">):</span>  <span class="c1"># pylint: disable=E1101</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>  <span class="c1"># pylint: disable=E1101</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">print_exc</span><span class="p">()</span>

        <span class="n">starter</span><span class="o">.</span><span class="n">cancel_handler</span><span class="p">(</span><span class="n">SIG_END</span><span class="p">)</span>
        <span class="n">starter</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">=</span> <span class="n">ERR_HPC_SCRIPT_MALFUNCTION</span>

    <span class="n">starter</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
    <span class="n">snk</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">taskid</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">starter</span><span class="o">.</span><span class="n">exitcode</span><span class="p">),))</span>


<span class="k">def</span> <span class="nf">_main_start</span><span class="p">():</span>  <span class="c1"># pylint: disable=R0911</span>
    <span class="sd">&quot;&quot;&quot;start to process the task....&quot;&quot;&quot;</span>
    <span class="n">verstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2">, version </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span> <span class="n">__version__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="n">HpcArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">verstr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="n">HpcArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">verstr</span><span class="p">)</span>

    <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;--taskid&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CCP_TASKID&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;task name from HPC&quot;</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="s2">&quot;--verblevel&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;be a bit more verbose&quot;</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--stdout&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;write to stdout as well&quot;</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--cwd&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">help</span><span class="o">=</span><span class="n">SUPPRESS</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--sched&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">SUPPRESS</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--fastwatch&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">SUPPRESS</span><span class="p">)</span>
    <span class="n">opts</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--id&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;if given it&#39;s just ignored&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2"> -&gt; Python </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) -&gt; HPC V </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gethostname</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">python_version_tuple</span><span class="p">()),</span> <span class="n">architecture</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">__version__</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">ArgumentParserError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;argument error: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ERR_HPC_WRONG_ARG</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">taskid</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>  <span class="c1"># used by test.bat</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span> <span class="s2">&quot;hpc&quot;</span><span class="p">,</span> <span class="s2">&quot;job.json&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">efp</span><span class="p">:</span>
            <span class="n">jobenv</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">efp</span><span class="p">)</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobenv</span><span class="p">[</span><span class="s2">&quot;tsk&quot;</span><span class="p">])</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">JobUnitType</span><span class="p">(</span><span class="n">jobenv</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">][</span><span class="s2">&quot;unit&quot;</span><span class="p">])</span>
            <span class="n">args</span><span class="o">.</span><span class="n">sched</span> <span class="o">=</span> <span class="n">jobenv</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">][</span><span class="s2">&quot;head&quot;</span><span class="p">]</span>

        <span class="n">cpus</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span>
        <span class="n">mpl</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">({</span><span class="s2">&quot;Node&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Socket&quot;</span><span class="p">:</span> <span class="n">cpus</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Core&quot;</span><span class="p">:</span> <span class="n">cpus</span><span class="p">}[</span><span class="nb">str</span><span class="p">(</span><span class="n">unit</span><span class="p">)])</span>
        <span class="n">snake</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_multi_start</span><span class="p">,</span> <span class="p">[(</span><span class="n">args</span><span class="o">.</span><span class="n">sched</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">snake</span><span class="p">,)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tasks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>

        <span class="n">ecode</span> <span class="o">=</span> <span class="n">ExitCodes</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;hpc.sqlite&quot;</span><span class="p">))</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">snake</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">taskid</span><span class="p">,</span> <span class="n">exitint</span> <span class="o">=</span> <span class="n">snake</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">texit</span> <span class="o">=</span> <span class="n">ExitCodes</span><span class="p">(</span><span class="n">ecode</span><span class="p">,</span> <span class="n">init_code</span><span class="o">=</span><span class="n">exitint</span><span class="p">)</span>
            <span class="n">ecode</span><span class="p">(</span><span class="n">texit</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;task </span><span class="si">{}</span><span class="s2">: exitcode </span><span class="si">{!s}</span><span class="s2"> (</span><span class="si">{!s}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">taskid</span><span class="p">,</span> <span class="n">texit</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">EXIT_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">texit</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">))))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">task output can be queried by issuing: (exchanging correct task id&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;python hpc\cmd\env_collector.py -d </span><span class="si">{}</span><span class="s2">\hpc.sqlite log -n </span><span class="si">{}</span><span class="s2"> -j </span><span class="si">{}</span><span class="s2"> -s &lt;task id&gt;&quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cwd</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">sched</span><span class="p">,</span> <span class="n">jobenv</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">][</span><span class="s2">&quot;jobid&quot;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">ecode</span><span class="o">.</span><span class="n">error</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">starter</span> <span class="o">=</span> <span class="n">AppStarter</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="n">starter</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">HpcError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ex</span><span class="o">.</span><span class="n">error</span>
    <span class="k">except</span> <span class="n">NoSuchFile</span><span class="p">:</span>  <span class="c1"># coming from Jobdict as no hpc.json found</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="c1"># catches all non system exiting exceptions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;no such task:&quot;</span><span class="p">):</span>  <span class="c1"># pylint: disable=E1101</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>  <span class="c1"># pylint: disable=E1101</span>
                <span class="k">return</span> <span class="n">ERR_HPC_INTERNAL_ERROR</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">print_exc</span><span class="p">()</span>

        <span class="n">starter</span><span class="o">.</span><span class="n">cancel_handler</span><span class="p">(</span><span class="n">SIG_END</span><span class="p">)</span>
        <span class="n">starter</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">=</span> <span class="n">ERR_HPC_SCRIPT_MALFUNCTION</span>

    <span class="n">frmt</span> <span class="o">=</span> <span class="s2">&quot;DB update time: </span><span class="si">{:.1f}</span><span class="s2">s&quot;</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verblevel</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">starter</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">timeit_frmt</span><span class="o">=</span><span class="n">frmt</span><span class="p">)</span>  <span class="c1"># pylint: disable=E1123</span>

    <span class="k">if</span> <span class="n">head_name</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;exitcode </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{!s}</span><span class="s2">): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">starter</span><span class="o">.</span><span class="n">exitcode</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">EXIT_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">starter</span><span class="o">.</span><span class="n">exitcode</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)),</span>
                                              <span class="n">starter</span><span class="o">.</span><span class="n">exitmessage</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">starter</span><span class="o">.</span><span class="n">exitcode</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ERR_INFRASTRUCTURE_FAILED_TO_COPY_DATA</span><span class="p">,</span> <span class="n">ERR_INFRASTRUCTURE_UNSPECIFIC_ERROR_FOUND</span><span class="p">,</span>
                                <span class="n">ERR_APP_ERR_NETWORK_UNAVAILABLE</span><span class="p">,</span> <span class="n">ERR_HPC_SCRIPT_MALFUNCTION</span><span class="p">,</span>
                                <span class="n">ERR_HPC_INTERNAL_ERROR</span><span class="p">,</span> <span class="n">ERR_HPC_PID_INVALID</span><span class="p">,</span> <span class="n">ERR_HPC_DATABASE</span><span class="p">,</span>
                                <span class="n">ERR_HPC_WRONG_ARG</span><span class="p">,</span> <span class="n">ERR_HPC_UNSPECIFIED_ERROR_FOUND</span><span class="p">,</span> <span class="n">ERR_HPC_LOW_DISK_SPACE</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">if you think it&#39;s an HPC / infrastructure problem, don&#39;t hesitate and let us know via&quot;</span>
                  <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">https://github-am.geo.conti.de/ADAS/HPC_two/issues&quot;</span><span class="p">)</span>

    <span class="c1"># special behaviour needed when ERR_INFRASTRUCTURE_FAILED_TO_CREATE_DATA: take node offline</span>
    <span class="c1"># if starter.exitcode in (ERR_INFRASTRUCTURE_FAILED_TO_COPY_DATA, ERR_INFRASTRUCTURE_FAILED_TO_CREATE_DATA):</span>
    <span class="c1">#     if take_offline():</span>
    <span class="c1">#         return ERR_INFRASTRUCTURE_FAILED_TO_CREATE_DATA</span>

    <span class="k">return</span> <span class="n">starter</span><span class="o">.</span><span class="n">exitcode</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">_main_start</span><span class="p">())</span>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">HPC 2.12.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, VDS.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.1.
    </div>
  </body>
</html>